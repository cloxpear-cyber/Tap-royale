<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tap Royale</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; overflow-x: hidden; }
        .container { max-width: 100%; padding: 10px; padding-bottom: 80px; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 10px; }
        .player-info { display: flex; flex-direction: column; cursor: pointer; }
        .player-name { font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .player-name .edit-icon { font-size: 12px; opacity: 0.6; }
        .player-level { font-size: 12px; color: #ffd700; }
        .currency-display { display: flex; gap: 15px; }
        .currency { display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: bold; }
        .gold { color: #ffd700; }
        .gems { color: #e91e63; }

        /* Daily Banner */
        .daily-banner { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); border-radius: 15px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .daily-banner.claimed { background: rgba(255,255,255,0.1); cursor: default; }
        .daily-info { display: flex; align-items: center; gap: 10px; }
        .daily-text { font-size: 14px; font-weight: bold; }
        .daily-sub { font-size: 11px; opacity: 0.9; }
        .daily-btn { background: rgba(255,255,255,0.3); border: none; padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold; }

        /* Pet Display */
        .pet-display { position: absolute; bottom: 15px; right: 15px; font-size: 40px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }

        /* Arena */
        .arena-container { position: relative; height: 280px; border-radius: 20px; overflow: hidden; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .arena-header { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: bold; }
        .character { font-size: 100px; cursor: pointer; user-select: none; transition: transform 0.1s; filter: drop-shadow(0 0 20px rgba(255,255,255,0.3)); }
        .character:active { transform: scale(0.85); }

        .tap-feedback { position: absolute; pointer-events: none; font-size: 24px; font-weight: bold; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.8); animation: float-up 0.8s ease-out forwards; }
        @keyframes float-up { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }

        /* Progress */
        .progress-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 10px; }
        .progress-item { margin-bottom: 10px; }
        .progress-item:last-child { margin-bottom: 0; }
        .progress-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        .progress-bar { height: 8px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s ease; }
        .progress-fill.exp { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .progress-fill.arena { background: linear-gradient(90deg, #2196f3, #03a9f4); }

        /* Stats */
        .stats-row { display: flex; justify-content: space-around; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 10px; margin-bottom: 10px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 18px; font-weight: bold; color: #ffd700; }
        .stat-label { font-size: 10px; opacity: 0.7; }

        /* Navigation */
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: rgba(26, 26, 46, 0.98); border-top: 1px solid rgba(255,255,255,0.1); padding: 5px 0; padding-bottom: max(5px, env(safe-area-inset-bottom)); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; opacity: 0.5; }
        .nav-item.active { opacity: 1; }
        .nav-item span:first-child { font-size: 20px; }
        .nav-item span:last-child { font-size: 9px; margin-top: 2px; }

        .screen { display: none; }
        .screen.active { display: block; }

        /* Shop */
        .section-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 15px; }
        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .shop-currency { display: flex; gap: 10px; }
        .shop-currency .currency { background: rgba(255,255,255,0.1); padding: 6px 10px; border-radius: 15px; font-size: 13px; }

        .tabs { display: flex; gap: 8px; margin-bottom: 15px; }
        .tab { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; font-size: 12px; cursor: pointer; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }

        .items-list { display: flex; flex-direction: column; gap: 10px; }
        .item-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .item-card.selected { border: 2px solid #4caf50; background: rgba(76,175,80,0.2); }
        .item-info h3 { font-size: 14px; margin-bottom: 2px; }
        .item-info p { font-size: 11px; opacity: 0.7; }
        .item-info .item-level { font-size: 11px; color: #4caf50; margin-top: 2px; }

        .btn { padding: 10px 16px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .btn:active { transform: scale(0.95); }
        .btn-gold { background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%); color: #1a1a2e; }
        .btn-gem { background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%); color: white; }
        .btn-green { background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); color: white; }
        .btn-blue { background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%); color: white; }
        .btn-full { width: 100%; justify-content: center; padding: 15px; font-size: 15px; }

        /* Referral */
        .referral-section { background: linear-gradient(135deg, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.2) 100%); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(102,126,234,0.3); }
        .referral-title { font-size: 16px; font-weight: bold; margin-bottom: 10px; }
        .referral-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .ref-stat { text-align: center; }
        .ref-stat-value { font-size: 24px; font-weight: bold; color: #ffd700; }
        .ref-stat-label { font-size: 11px; opacity: 0.7; }
        .referral-info { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 15px; font-size: 12px; line-height: 1.6; }
        .ref-link-box { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 10px; margin-top: 10px; display: flex; align-items: center; gap: 10px; }
        .ref-link-text { flex: 1; font-size: 10px; word-break: break-all; opacity: 0.8; }

        /* Leaderboard */
        .lb-list { display: flex; flex-direction: column; gap: 8px; }
        .lb-item { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 10px 12px; display: flex; align-items: center; gap: 10px; }
        .lb-item.me { background: linear-gradient(135deg, rgba(102,126,234,0.3) 0%, rgba(118,75,162,0.3) 100%); border: 1px solid rgba(102,126,234,0.5); }
        .lb-rank { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 12px; background: rgba(255,255,255,0.2); }
        .lb-rank.top1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; }
        .lb-rank.top2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #1a1a2e; }
        .lb-rank.top3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: white; }
        .lb-info { flex: 1; }
        .lb-name { font-size: 13px; font-weight: bold; }
        .lb-sub { font-size: 10px; opacity: 0.7; }
        .lb-value { font-size: 13px; font-weight: bold; color: #ffd700; }

        /* Guild */
        .guild-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .guild-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .guild-name { font-size: 18px; font-weight: bold; }
        .guild-stats { display: flex; gap: 20px; margin-bottom: 10px; }
        .guild-stat { text-align: center; }
        .guild-stat-value { font-size: 20px; font-weight: bold; color: #ffd700; }
        .guild-stat-label { font-size: 10px; opacity: 0.7; }
        .guild-members { font-size: 12px; opacity: 0.8; }

        .create-guild-form { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px; margin-bottom: 10px; outline: none; }
        .form-input::placeholder { color: rgba(255,255,255,0.5); }

        /* Accordion */
        .accordion { background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
        .accordion-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .accordion-title { font-size: 15px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .accordion-arrow { transition: transform 0.3s; }
        .accordion.open .accordion-arrow { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .accordion.open .accordion-content { max-height: 1000px; }
        .accordion-inner { padding: 0 15px 15px; }

        .guide-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 8px; }
        .guide-item:last-child { margin-bottom: 0; }
        .guide-item.current { background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3)); border: 1px solid rgba(102,126,234,0.5); }
        .guide-item.locked { opacity: 0.5; }
        .guide-icon { font-size: 28px; width: 35px; text-align: center; }
        .guide-info { flex: 1; }
        .guide-name { font-size: 13px; font-weight: bold; }
        .guide-req { font-size: 11px; opacity: 0.7; }
        .guide-status { font-size: 16px; }

        /* Toast */
        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 25px; font-size: 14px; opacity: 0; transition: all 0.3s ease; z-index: 1000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 25px; width: 100%; max-width: 300px; }
        .modal-title { font-size: 18px; font-weight: bold; margin-bottom: 20px; text-align: center; }
        .modal-icon { font-size: 50px; text-align: center; margin-bottom: 15px; }
        .modal-text { font-size: 14px; text-align: center; margin-bottom: 20px; opacity: 0.9; }
        .modal-rewards { display: flex; justify-content: center; gap: 30px; margin-bottom: 20px; }
        .modal-reward { text-align: center; }
        .modal-reward-icon { font-size: 28px; }
        .modal-reward-amount { font-size: 16px; font-weight: bold; color: #ffd700; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons .btn { flex: 1; justify-content: center; }

        /* Boosts */
        .active-boosts { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .boost-badge { background: linear-gradient(135deg, #e91e63, #9c27b0); padding: 5px 10px; border-radius: 15px; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- GAME SCREEN -->
        <div id="screen-game" class="screen active">
            <div class="header">
                <div class="player-info" id="open-nick">
                    <div class="player-name"><span id="player-name">–ò–≥—Ä–æ–∫</span> <span class="edit-icon">‚úèÔ∏è</span></div>
                    <div class="player-level">–£—Ä–æ–≤–µ–Ω—å <span id="player-level">1</span></div>
                </div>
                <div class="currency-display">
                    <div class="currency gold">ü™ô <span id="gold-display">0</span></div>
                    <div class="currency gems">üíé <span id="gems-display">0</span></div>
                </div>
            </div>

            <div id="daily-banner" class="daily-banner">
                <div class="daily-info">
                    <span style="font-size:24px">üéÅ</span>
                    <div>
                        <div class="daily-text">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞!</div>
                        <div class="daily-sub">–î–µ–Ω—å <span id="daily-streak">1</span></div>
                    </div>
                </div>
                <div class="daily-btn">–ó–∞–±—Ä–∞—Ç—å</div>
            </div>

            <div id="active-boosts" class="active-boosts"></div>

            <div id="arena-container" class="arena-container">
                <div class="arena-header">
                    <span id="arena-hero">üó°Ô∏è</span>
                    <span id="arena-name">üè∞ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ª–∞–≥–µ—Ä—å</span>
                </div>
                <div class="character" id="character">üó°Ô∏è</div>
                <div class="pet-display" id="pet-display">üê£</div>
            </div>

            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-label">
                        <span>–û–ø—ã—Ç</span>
                        <span><span id="current-exp">0</span> / <span id="exp-needed">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill exp" id="exp-bar"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>–î–æ –∞—Ä–µ–Ω—ã</span>
                        <span>–£—Ä. <span id="next-arena-level">5</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill arena" id="arena-bar"></div>
                    </div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="gold-per-tap">+1</div>
                    <div class="stat-label">–∑–∞ —Ç–∞–ø</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="gold-per-sec">+0</div>
                    <div class="stat-label">–≤ —Å–µ–∫—É–Ω–¥—É</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-taps">0</div>
                    <div class="stat-label">—Ç–∞–ø–æ–≤</div>
                </div>
            </div>
        </div>

        <!-- SHOP SCREEN -->
        <div id="screen-shop" class="screen">
            <div class="shop-header">
                <div class="section-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
                <div class="shop-currency">
                    <div class="currency gold">ü™ô <span id="shop-gold">0</span></div>
                    <div class="currency gems">üíé <span id="shop-gems">0</span></div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="upgrades">‚ö° –£–ª—É—á—à–µ–Ω–∏—è</button>
                <button class="tab" data-tab="boosts">üíé –ë—É—Å—Ç—ã</button>
                <button class="tab" data-tab="pets">üêæ –ü–∏—Ç–æ–º—Ü—ã</button>
            </div>

            <div id="tab-upgrades" class="items-list"></div>
            <div id="tab-boosts" class="items-list" style="display:none"></div>
            <div id="tab-pets" class="items-list" style="display:none"></div>
        </div>

        <!-- TOP SCREEN -->
        <div id="screen-top" class="screen">
            <div class="section-title">üèÜ –†–µ–π—Ç–∏–Ω–≥</div>

            <div class="referral-section">
                <div class="referral-title">üë• –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π</div>
                <div class="referral-stats">
                    <div class="ref-stat">
                        <div class="ref-stat-value" id="ref-count">0</div>
                        <div class="ref-stat-label">–¥—Ä—É–∑–µ–π</div>
                    </div>
                    <div class="ref-stat">
                        <div class="ref-stat-value" id="ref-bonus">+0</div>
                        <div class="ref-stat-label">–±–æ–Ω—É—Å/—Å–µ–∫</div>
                    </div>
                </div>
                <div class="referral-info">üéÅ –ó–∞ –¥—Ä—É–≥–∞: +500 ü™ô +3 üíé ‚Ä¢ –ü–∞—Å—Å–∏–≤: +5/—Å–µ–∫</div>
                <button class="btn btn-green btn-full" id="invite-btn">üì® –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</button>
                <div class="ref-link-box">
                    <div class="ref-link-text" id="ref-link">–°—Å—ã–ª–∫–∞...</div>
                    <button class="btn btn-blue" id="copy-btn">üìã</button>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-lb="level">üéñÔ∏è –£—Ä–æ–≤–µ–Ω—å</button>
                <button class="tab" data-lb="gold">ü™ô –ó–æ–ª–æ—Ç–æ</button>
                <button class="tab" data-lb="refs">üë• –î—Ä—É–∑—å—è</button>
            </div>

            <div id="leaderboard" class="lb-list"></div>
        </div>

        <!-- GUILD SCREEN -->
        <div id="screen-guild" class="screen">
            <div class="section-title">üè∞ –ì–∏–ª—å–¥–∏—è</div>

            <div id="guild-content"></div>

            <div class="section-title" style="margin-top:20px">üèÜ –¢–æ–ø –≥–∏–ª—å–¥–∏–π</div>
            <div id="guild-leaderboard" class="lb-list"></div>
        </div>

        <!-- INFO SCREEN -->
        <div id="screen-info" class="screen">
            <div class="section-title">üìñ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>

            <div class="accordion" id="acc-arenas">
                <div class="accordion-header">
                    <div class="accordion-title">üèüÔ∏è –ê—Ä–µ–Ω—ã <span id="arena-count">(0/10)</span></div>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-inner" id="arenas-list"></div>
                </div>
            </div>

            <div class="accordion" id="acc-heroes">
                <div class="accordion-header">
                    <div class="accordion-title">ü¶∏ –ì–µ—Ä–æ–∏ <span id="hero-count">(0/10)</span></div>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-inner" id="heroes-list"></div>
                </div>
            </div>

            <div class="accordion" id="acc-tips">
                <div class="accordion-header">
                    <div class="accordion-title">üí° –°–æ–≤–µ—Ç—ã</div>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <p style="font-size:13px;line-height:1.8">
                            ‚ö° –ö–∞—á–∞–π —Å–∏–ª—É —Ç–∞–ø–∞ ‚Äî –æ—Å–Ω–æ–≤–∞ –¥–æ—Ö–æ–¥–∞<br>
                            ü§ñ –ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –∫–æ–≥–¥–∞ –Ω–µ –∏–≥—Ä–∞–µ—à—å<br>
                            üíé –ì–µ–º—ã: –∫–∞–∂–¥—ã–µ 50 —Ç–∞–ø–æ–≤ +1 –≥–µ–º<br>
                            üéÅ –ó–∞—Ö–æ–¥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –∑–∞ –Ω–∞–≥—Ä–∞–¥–æ–π<br>
                            üêæ –ü–∏—Ç–æ–º—Ü—ã –¥–∞—é—Ç –ø–∞—Å—Å–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã<br>
                            üè∞ –í—Å—Ç—É–ø–∏ –≤ –≥–∏–ª—å–¥–∏—é –¥–ª—è –±–æ–Ω—É—Å–æ–≤
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <div class="nav-bar">
        <div class="nav-item active" data-screen="game"><span>üéÆ</span><span>–ò–≥—Ä–∞</span></div>
        <div class="nav-item" data-screen="shop"><span>üõí</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" data-screen="top"><span>üèÜ</span><span>–¢–æ–ø</span></div>
        <div class="nav-item" data-screen="guild"><span>üè∞</span><span>–ì–∏–ª—å–¥–∏—è</span></div>
        <div class="nav-item" data-screen="info"><span>üìñ</span><span>–ò–Ω—Ñ–æ</span></div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <!-- DAILY MODAL -->
    <div id="daily-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üéÅ –î–µ–Ω—å <span id="modal-day">1</span></div>
            <div class="modal-icon">üéâ</div>
            <div class="modal-rewards">
                <div class="modal-reward">
                    <div class="modal-reward-icon">ü™ô</div>
                    <div class="modal-reward-amount" id="modal-gold">+100</div>
                </div>
                <div class="modal-reward">
                    <div class="modal-reward-icon">üíé</div>
                    <div class="modal-reward-amount" id="modal-gems">+1</div>
                </div>
            </div>
            <button class="btn btn-green btn-full" id="claim-daily-btn">–ó–∞–±—Ä–∞—Ç—å!</button>
        </div>
    </div>

    <!-- NICKNAME MODAL -->
    <div id="nick-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫</div>
            <input type="text" class="form-input" id="nick-input" placeholder="–í–≤–µ–¥–∏ –Ω–æ–≤—ã–π –Ω–∏–∫" maxlength="15">
            <div class="modal-buttons">
                <button class="btn" style="background:rgba(255,255,255,0.1)" id="nick-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-green" id="nick-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- CREATE GUILD MODAL -->
    <div id="create-guild-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üè∞ –°–æ–∑–¥–∞—Ç—å –≥–∏–ª—å–¥–∏—é</div>
            <div class="modal-text">–°—Ç–æ–∏–º–æ—Å—Ç—å: 5 üíé</div>
            <input type="text" class="form-input" id="guild-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥–∏–ª—å–¥–∏–∏" maxlength="15">
            <div class="modal-buttons">
                <button class="btn" style="background:rgba(255,255,255,0.1)" id="guild-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-gem" id="guild-create">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

<script>
// ============ CONFIG ============
const API_URL = 'https://taproyaleserver.onrender.com';
const BOT_USERNAME = 'TapRoyaleGame_bot';

// ============ DATA ============
const ARENAS = [
    { name: 'üè∞ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ª–∞–≥–µ—Ä—å', lvl: 1, bg: 'linear-gradient(135deg, #2d5016, #1a3a0a)' },
    { name: '‚öîÔ∏è –î–µ—Ä–µ–≤–Ω—è –≥–æ–±–ª–∏–Ω–æ–≤', lvl: 5, bg: 'linear-gradient(135deg, #4a5d23, #2e3d14)' },
    { name: 'üèØ –ö–æ—Å—Ç—è–Ω–æ–π –ª–µ—Å', lvl: 12, bg: 'linear-gradient(135deg, #3d3d3d, #1a1a1a)' },
    { name: 'üé™ –í–∞—Ä–≤–∞—Ä—Å–∫–∞—è –∞—Ä–µ–Ω–∞', lvl: 20, bg: 'linear-gradient(135deg, #8b4513, #5d2e0a)' },
    { name: '‚õèÔ∏è –®–∞—Ö—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â', lvl: 30, bg: 'linear-gradient(135deg, #6b4423, #3d2613)' },
    { name: 'üèõÔ∏è –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –¥–≤–æ—Ä', lvl: 42, bg: 'linear-gradient(135deg, #4a148c, #311b92)' },
    { name: 'üåã –û–≥–Ω–µ–Ω–Ω—ã–π –ø–∏–∫', lvl: 55, bg: 'linear-gradient(135deg, #bf360c, #8d1c06)' },
    { name: '‚ùÑÔ∏è –õ–µ–¥—è–Ω–∞—è –ø—É—Å—Ç–æ—à—å', lvl: 70, bg: 'linear-gradient(135deg, #0277bd, #01579b)' },
    { name: '‚ö° –ù–µ–±–µ—Å–Ω–∞—è –±–∞—à–Ω—è', lvl: 88, bg: 'linear-gradient(135deg, #6a1b9a, #4a148c)' },
    { name: 'üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è', lvl: 100, bg: 'linear-gradient(135deg, #ffd700, #b8860b)' }
];

const HEROES = [
    { name: '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü', emoji: 'üó°Ô∏è', lvl: 1 },
    { name: '–õ—É—á–Ω–∏–∫', emoji: 'üèπ', lvl: 5 },
    { name: '–í–∞—Ä–≤–∞—Ä', emoji: '‚öîÔ∏è', lvl: 12 },
    { name: '–†—ã—Ü–∞—Ä—å', emoji: 'üõ°Ô∏è', lvl: 20 },
    { name: '–í–µ–ª–∏–∫–∞–Ω', emoji: 'üëä', lvl: 30 },
    { name: '–ú–∞–≥', emoji: 'üßô', lvl: 42 },
    { name: '–î—Ä–∞–∫–æ–Ω', emoji: 'üêâ', lvl: 55 },
    { name: '–õ–µ–¥—è–Ω–æ–π –º–∞–≥', emoji: 'üßä', lvl: 70 },
    { name: '–ü—Ä–∏–Ω—Ü', emoji: 'ü§¥', lvl: 88 },
    { name: '–ö–æ—Ä–æ–ª—å', emoji: 'üëë', lvl: 100 }
];

const PETS = [
    { id: 'chick', name: '–¶—ã–ø–ª—ë–Ω–æ–∫', emoji: 'üê£', bonus: '+5% –∑–∞ —Ç–∞–ø', cost: 0, mult: { tap: 1.05 } },
    { id: 'cat', name: '–ö–æ—Ç–∏–∫', emoji: 'üê±', bonus: '+10% –∞–≤—Ç–æ', cost: 20, mult: { auto: 1.1 } },
    { id: 'dog', name: '–ü—ë—Å–∏–∫', emoji: 'üê∂', bonus: '+1 –æ–ø—ã—Ç/—Ç–∞–ø', cost: 25, mult: { exp: 1 } },
    { id: 'fox', name: '–õ–∏—Å–∏—á–∫–∞', emoji: 'ü¶ä', bonus: '+5% –∫—Ä–∏—Ç', cost: 40, mult: { crit: 5 } },
    { id: 'dragon', name: '–î—Ä–∞–∫–æ–Ω—á–∏–∫', emoji: 'üêâ', bonus: '+20% –≤—Å—ë', cost: 100, mult: { all: 1.2 } },
    { id: 'unicorn', name: '–ï–¥–∏–Ω–æ—Ä–æ–≥', emoji: 'ü¶Ñ', bonus: 'x2 –≥–µ–º—ã', cost: 150, mult: { gems: 2 } }
];

const UPGRADES = [
    { id: 'tap', name: '‚ö° –°–∏–ª–∞ —Ç–∞–ø–∞', desc: '+2 –∑–æ–ª–æ—Ç–∞ –∑–∞ –∫–ª–∏–∫', baseCost: 100 },
    { id: 'auto', name: 'ü§ñ –ê–≤—Ç–æ-–¥–æ—Ö–æ–¥', desc: '+5 –∑–æ–ª–æ—Ç–∞/—Å–µ–∫', baseCost: 250 },
    { id: 'exp', name: 'üìà –û–ø—ã—Ç', desc: '+1 –æ–ø—ã—Ç –∑–∞ –∫–ª–∏–∫', baseCost: 500 },
    { id: 'crit', name: 'üéØ –ö—Ä–∏—Ç', desc: '+5% —à–∞–Ω—Å x3', baseCost: 1000 }
];

const BOOSTS = [
    { id: 'double', name: 'üî• x2 –∑–æ–ª–æ—Ç–æ', desc: '5 –º–∏–Ω—É—Ç', cost: 5, dur: 300000 },
    { id: 'super', name: 'üí• x10 —Ç–∞–ø', desc: '1 –º–∏–Ω—É—Ç–∞', cost: 10, dur: 60000 },
    { id: 'megaexp', name: '‚≠ê +1000 –æ–ø—ã—Ç–∞', desc: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ', cost: 8, dur: 0 },
    { id: 'gold500', name: 'üí∞ +500 –∑–æ–ª–æ—Ç–∞', desc: '–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ', cost: 3, dur: 0 }
];

const DAILY = [{g:100,d:1},{g:150,d:1},{g:200,d:2},{g:300,d:2},{g:400,d:3},{g:500,d:4},{g:750,d:5}];

// ============ STATE ============
let G = {
    tgId: null,
    nick: '–ò–≥—Ä–æ–∫',
    gold: 0,
    gems: 0,
    level: 1,
    exp: 0,
    taps: 0,
    tapsForGem: 0,
    upgrades: { tap: 0, auto: 0, exp: 0, crit: 0 },
    costs: { tap: 100, auto: 250, exp: 500, crit: 1000 },
    refs: 0,
    streak: 1,
    lastDaily: null,
    boostDouble: 0,
    boostSuper: 0,
    pets: ['chick'],
    activePet: 'chick',
    guild: null,
    guildName: ''
};

// ============ INIT ============
function init() {
    load();
    initTG();
    initEvents();
    checkDaily();
    render();
    renderShop();
    renderGuide();
    loadLeaderboard('level');
    renderGuild();

    setInterval(autoIncome, 1000);
    setInterval(updateBoosts, 1000);
    setInterval(() => syncServer(), 30000);
}

function initTG() {
    if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        const u = Telegram.WebApp.initDataUnsafe?.user;
        if (u) {
            G.tgId = u.id;
            if (!localStorage.getItem('nickSet')) G.nick = u.first_name || '–ò–≥—Ä–æ–∫';
        }
        const sp = Telegram.WebApp.initDataUnsafe?.start_param;
        if (sp && sp.startsWith('ref')) {
            const refId = sp.replace('ref', '');
            if (refId && refId != G.tgId && !localStorage.getItem('refDone')) {
                G.gold += 500; G.gems += 3;
                localStorage.setItem('refDone', '1');
                toast('üéÅ +500 –∑–æ–ª–æ—Ç–∞, +3 –≥–µ–º–∞!', 'success');
                save();
            }
        }
    }
    updateRefLink();
}

function initEvents() {
    // Tap
    document.getElementById('character').addEventListener('click', tap);

    // Navigation
    document.querySelectorAll('.nav-item').forEach(el => {
        el.addEventListener('click', () => switchScreen(el.dataset.screen));
    });

    // Shop tabs
    document.querySelectorAll('.tabs .tab[data-tab]').forEach(el => {
        el.addEventListener('click', () => switchShopTab(el.dataset.tab));
    });

    // Leaderboard tabs
    document.querySelectorAll('.tabs .tab[data-lb]').forEach(el => {
        el.addEventListener('click', () => {
            document.querySelectorAll('.tab[data-lb]').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            loadLeaderboard(el.dataset.lb);
        });
    });

    // Accordions
    document.querySelectorAll('.accordion-header').forEach(el => {
        el.addEventListener('click', () => el.parentElement.classList.toggle('open'));
    });

    // Daily
    document.getElementById('daily-banner').addEventListener('click', openDaily);
    document.getElementById('claim-daily-btn').addEventListener('click', claimDaily);

    // Nickname
    document.getElementById('open-nick').addEventListener('click', () => {
        document.getElementById('nick-input').value = G.nick;
        document.getElementById('nick-modal').classList.add('show');
    });
    document.getElementById('nick-cancel').addEventListener('click', () => {
        document.getElementById('nick-modal').classList.remove('show');
    });
    document.getElementById('nick-save').addEventListener('click', saveNick);

    // Referral
    document.getElementById('invite-btn').addEventListener('click', invite);
    document.getElementById('copy-btn').addEventListener('click', copyLink);

    // Guild
    document.getElementById('guild-cancel').addEventListener('click', () => {
        document.getElementById('create-guild-modal').classList.remove('show');
    });
    document.getElementById('guild-create').addEventListener('click', createGuild);
}

// ============ GAME ============
function tap(e) {
    const pet = PETS.find(p => p.id === G.activePet) || PETS[0];

    // Base gold
    let gold = 1 + G.upgrades.tap * 2;

    // Pet tap bonus
    if (pet.mult.tap) gold *= pet.mult.tap;
    if (pet.mult.all) gold *= pet.mult.all;

    // Crit
    let critChance = G.upgrades.crit * 5;
    if (pet.mult.crit) critChance += pet.mult.crit;
    if (Math.random() * 100 < critChance) gold *= 3;

    // Boosts
    if (G.boostDouble > Date.now()) gold *= 2;
    if (G.boostSuper > Date.now()) gold *= 10;

    // Guild bonus
    if (G.guild) gold *= 1.1;

    G.gold += Math.floor(gold);
    G.taps++;
    G.tapsForGem++;

    // Gems
    let gemsNeeded = 50;
    if (pet.mult.gems) gemsNeeded = 25;
    if (G.tapsForGem >= gemsNeeded) {
        G.gems++;
        G.tapsForGem = 0;
        toast('üíé +1 –≥–µ–º!', 'success');
    }

    // Exp
    let expGain = 1 + G.upgrades.exp;
    if (pet.mult.exp) expGain += pet.mult.exp;
    if (pet.mult.all) expGain *= pet.mult.all;
    G.exp += Math.floor(expGain);
    checkLevelUp();

    showTapFeedback(e, Math.floor(gold));
    render();
    save();
}

function checkLevelUp() {
    let need = getExpNeed();
    while (G.exp >= need) {
        G.exp -= need;
        G.level++;
        toast('üéâ –£—Ä–æ–≤–µ–Ω—å ' + G.level + '!', 'success');
        need = getExpNeed();
    }
}

function getExpNeed() {
    return Math.floor(100 * Math.pow(1.5, G.level - 1));
}

function getGoldPerTap() {
    let base = 1 + G.upgrades.tap * 2;
    const pet = PETS.find(p => p.id === G.activePet);
    if (pet?.mult.tap) base *= pet.mult.tap;
    if (pet?.mult.all) base *= pet.mult.all;
    return Math.floor(base);
}

function getGoldPerSec() {
    let base = G.upgrades.auto * 5 + G.refs * 5;
    const pet = PETS.find(p => p.id === G.activePet);
    if (pet?.mult.auto) base *= pet.mult.auto;
    if (pet?.mult.all) base *= pet.mult.all;
    if (G.guild) base *= 1.1;
    return Math.floor(base);
}

function autoIncome() {
    const inc = getGoldPerSec();
    if (inc > 0) {
        let gold = inc;
        if (G.boostDouble > Date.now()) gold *= 2;
        G.gold += Math.floor(gold);
        render();
        save();
    }
}

// ============ SHOP ============
function renderShop() {
    // Upgrades
    let html = '';
    UPGRADES.forEach(u => {
        html += `<div class="item-card">
            <div class="item-info">
                <h3>${u.name}</h3>
                <p>${u.desc}</p>
                <div class="item-level">–£—Ä–æ–≤–µ–Ω—å: ${G.upgrades[u.id]}</div>
            </div>
            <button class="btn btn-gold" data-buy="${u.id}">ü™ô ${formatNum(G.costs[u.id])}</button>
        </div>`;
    });
    document.getElementById('tab-upgrades').innerHTML = html;

    // Boosts
    html = '';
    BOOSTS.forEach(b => {
        html += `<div class="item-card">
            <div class="item-info">
                <h3>${b.name}</h3>
                <p>${b.desc}</p>
            </div>
            <button class="btn btn-gem" data-boost="${b.id}">üíé ${b.cost}</button>
        </div>`;
    });
    document.getElementById('tab-boosts').innerHTML = html;

    // Pets
    html = '';
    PETS.forEach(p => {
        const owned = G.pets.includes(p.id);
        const active = G.activePet === p.id;
        html += `<div class="item-card ${active ? 'selected' : ''}">
            <div class="item-info">
                <h3>${p.emoji} ${p.name}</h3>
                <p>${p.bonus}</p>
            </div>
            ${owned 
                ? `<button class="btn ${active ? 'btn-green' : 'btn-blue'}" data-pet="${p.id}">${active ? '‚úì' : '–í—ã–±—Ä–∞—Ç—å'}</button>`
                : `<button class="btn btn-gem" data-buypet="${p.id}">üíé ${p.cost}</button>`
            }
        </div>`;
    });
    document.getElementById('tab-pets').innerHTML = html;

    // Events
    document.querySelectorAll('[data-buy]').forEach(el => {
        el.addEventListener('click', () => buyUpgrade(el.dataset.buy));
    });
    document.querySelectorAll('[data-boost]').forEach(el => {
        el.addEventListener('click', () => buyBoost(el.dataset.boost));
    });
    document.querySelectorAll('[data-pet]').forEach(el => {
        el.addEventListener('click', () => selectPet(el.dataset.pet));
    });
    document.querySelectorAll('[data-buypet]').forEach(el => {
        el.addEventListener('click', () => buyPet(el.dataset.buypet));
    });
}

function buyUpgrade(id) {
    const cost = G.costs[id];
    if (G.gold < cost) return toast('‚ùå –ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!', 'error');

    G.gold -= cost;
    G.upgrades[id]++;
    G.costs[id] = Math.floor(G.costs[id] * 1.8);

    toast('‚úÖ –ö—É–ø–ª–µ–Ω–æ!', 'success');
    render();
    renderShop();
    save();
}

function buyBoost(id) {
    const boost = BOOSTS.find(b => b.id === id);
    if (G.gems < boost.cost) return toast('‚ùå –ú–∞–ª–æ –≥–µ–º–æ–≤!', 'error');

    G.gems -= boost.cost;

    if (id === 'double') { G.boostDouble = Date.now() + boost.dur; toast('üî• x2 –Ω–∞ 5 –º–∏–Ω!', 'success'); }
    else if (id === 'super') { G.boostSuper = Date.now() + boost.dur; toast('üí• x10 –Ω–∞ 1 –º–∏–Ω!', 'success'); }
    else if (id === 'megaexp') { G.exp += 1000; checkLevelUp(); toast('‚≠ê +1000 –æ–ø—ã—Ç–∞!', 'success'); }
    else if (id === 'gold500') { G.gold += 500; toast('üí∞ +500 –∑–æ–ª–æ—Ç–∞!', 'success'); }

    render();
    save();
}

function buyPet(id) {
    const pet = PETS.find(p => p.id === id);
    if (G.gems < pet.cost) return toast('‚ùå –ú–∞–ª–æ –≥–µ–º–æ–≤!', 'error');

    G.gems -= pet.cost;
    G.pets.push(id);
    G.activePet = id;

    toast('üéâ –ü–∏—Ç–æ–º–µ—Ü ' + pet.emoji + ' –∫—É–ø–ª–µ–Ω!', 'success');
    render();
    renderShop();
    save();
}

function selectPet(id) {
    G.activePet = id;
    const pet = PETS.find(p => p.id === id);
    toast(pet.emoji + ' –≤—ã–±—Ä–∞–Ω!', 'success');
    render();
    renderShop();
    save();
}

function switchShopTab(tab) {
    document.querySelectorAll('.tab[data-tab]').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');

    document.getElementById('tab-upgrades').style.display = tab === 'upgrades' ? 'flex' : 'none';
    document.getElementById('tab-boosts').style.display = tab === 'boosts' ? 'flex' : 'none';
    document.getElementById('tab-pets').style.display = tab === 'pets' ? 'flex' : 'none';
}

// ============ DAILY ============
function checkDaily() {
    const today = new Date().toDateString();
    const banner = document.getElementById('daily-banner');

    if (G.lastDaily === today) {
        banner.classList.add('claimed');
        banner.querySelector('.daily-text').textContent = '–ü–æ–ª—É—á–µ–Ω–æ!';
        banner.querySelector('.daily-btn').textContent = '‚úì';
    } else {
        banner.classList.remove('claimed');
        banner.querySelector('.daily-text').textContent = '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞!';
        banner.querySelector('.daily-btn').textContent = '–ó–∞–±—Ä–∞—Ç—å';

        if (G.lastDaily) {
            const diff = Math.floor((new Date(today) - new Date(G.lastDaily)) / 86400000);
            if (diff === 1) G.streak = Math.min(G.streak + 1, 7);
            else if (diff > 1) G.streak = 1;
        }
    }
}

function openDaily() {
    if (G.lastDaily === new Date().toDateString()) return;
    const r = DAILY[G.streak - 1] || DAILY[6];
    document.getElementById('modal-day').textContent = G.streak;
    document.getElementById('modal-gold').textContent = '+' + r.g;
    document.getElementById('modal-gems').textContent = '+' + r.d;
    document.getElementById('daily-modal').classList.add('show');
}

function claimDaily() {
    const r = DAILY[G.streak - 1] || DAILY[6];
    G.gold += r.g;
    G.gems += r.d;
    G.lastDaily = new Date().toDateString();
    document.getElementById('daily-modal').classList.remove('show');
    toast('üéÅ +' + r.g + ' ü™ô +' + r.d + ' üíé', 'success');
    checkDaily();
    render();
    save();
}

// ============ NICKNAME ============
function saveNick() {
    const nick = document.getElementById('nick-input').value.trim();
    if (nick.length < 2) return toast('‚ùå –ú–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞', 'error');
    G.nick = nick;
    localStorage.setItem('nickSet', '1');
    document.getElementById('nick-modal').classList.remove('show');
    toast('‚úÖ –ù–∏–∫ –∏–∑–º–µ–Ω—ë–Ω!', 'success');
    render();
    save();
}

// ============ GUILD ============
function renderGuild() {
    const c = document.getElementById('guild-content');

    if (G.guild) {
        c.innerHTML = `
            <div class="guild-card">
                <div class="guild-header">
                    <div class="guild-name">üè∞ ${G.guildName}</div>
                </div>
                <div class="guild-stats">
                    <div class="guild-stat">
                        <div class="guild-stat-value">1</div>
                        <div class="guild-stat-label">—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                    <div class="guild-stat">
                        <div class="guild-stat-value">+10%</div>
                        <div class="guild-stat-label">–±–æ–Ω—É—Å</div>
                    </div>
                </div>
                <button class="btn btn-full" style="background:rgba(255,255,255,0.1)" id="leave-guild">–ü–æ–∫–∏–Ω—É—Ç—å</button>
            </div>`;
        document.getElementById('leave-guild').addEventListener('click', leaveGuild);
    } else {
        c.innerHTML = `
            <div class="create-guild-form">
                <p style="text-align:center;margin-bottom:15px;opacity:0.8">–°–æ–∑–¥–∞–π —Å–≤–æ—é –≥–∏–ª—å–¥–∏—é –∏–ª–∏ –≤—Å—Ç—É–ø–∏ –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é!</p>
                <p style="text-align:center;margin-bottom:15px;font-size:13px">üéÅ –ë–æ–Ω—É—Å –≥–∏–ª—å–¥–∏–∏: +10% –∫ –¥–æ—Ö–æ–¥—É</p>
                <button class="btn btn-gem btn-full" id="open-create-guild">üè∞ –°–æ–∑–¥–∞—Ç—å –≥–∏–ª—å–¥–∏—é (5 üíé)</button>
            </div>`;
        document.getElementById('open-create-guild').addEventListener('click', () => {
            document.getElementById('guild-name-input').value = '';
            document.getElementById('create-guild-modal').classList.add('show');
        });
    }

    renderGuildLeaderboard();
}

function createGuild() {
    const name = document.getElementById('guild-name-input').value.trim();
    if (name.length < 2) return toast('‚ùå –ú–∏–Ω. 2 —Å–∏–º–≤–æ–ª–∞', 'error');
    if (G.gems < 5) return toast('‚ùå –ù—É–∂–Ω–æ 5 –≥–µ–º–æ–≤', 'error');

    G.gems -= 5;
    G.guild = 'guild_' + Date.now();
    G.guildName = name;

    document.getElementById('create-guild-modal').classList.remove('show');
    toast('üè∞ –ì–∏–ª—å–¥–∏—è —Å–æ–∑–¥–∞–Ω–∞!', 'success');
    render();
    renderGuild();
    save();
}

function leaveGuild() {
    G.guild = null;
    G.guildName = '';
    toast('–í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥–∏–ª—å–¥–∏—é', 'success');
    render();
    renderGuild();
    save();
}

function renderGuildLeaderboard() {
    const c = document.getElementById('guild-leaderboard');
    // Demo data
    const guilds = [
        { name: '–õ–µ–≥–µ–Ω–¥—ã', members: 18, level: 850 },
        { name: '–î—Ä–∞–∫–æ–Ω—ã', members: 15, level: 720 },
        { name: '–í–æ–∏–Ω—ã', members: 12, level: 540 }
    ];

    if (G.guild) {
        guilds.push({ name: G.guildName, members: 1, level: G.level, me: true });
        guilds.sort((a, b) => b.level - a.level);
    }

    let html = '';
    guilds.forEach((g, i) => {
        const rc = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
        html += `<div class="lb-item ${g.me ? 'me' : ''}">
            <div class="lb-rank ${rc}">${i + 1}</div>
            <div class="lb-info">
                <div class="lb-name">üè∞ ${g.name}</div>
                <div class="lb-sub">${g.members} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
            </div>
            <div class="lb-value">–£—Ä. ${g.level}</div>
        </div>`;
    });
    c.innerHTML = html;
}

// ============ LEADERBOARD ============
async function loadLeaderboard(type) {
    const c = document.getElementById('leaderboard');
    c.innerHTML = '<div style="text-align:center;padding:20px;opacity:0.6">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

    let data = [];
    try {
        const res = await fetch(API_URL + '/api/leaderboard?type=' + type);
        if (res.ok) data = await res.json();
    } catch(e) {}

    if (!data.length) {
        data = [
            { nickname: 'ProGamer', level: 95, gold: 1250000, referrals: 25 },
            { nickname: 'TapMaster', level: 78, gold: 890000, referrals: 18 },
            { nickname: 'SpeedRunner', level: 48, gold: 420000, referrals: 8 }
        ];
    }

    let html = '';
    data.slice(0, 10).forEach((p, i) => {
        const rc = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
        let val = type === 'level' ? '–£—Ä. ' + p.level : type === 'gold' ? formatNum(p.gold) + ' ü™ô' : p.referrals + ' üë•';
        html += `<div class="lb-item">
            <div class="lb-rank ${rc}">${i + 1}</div>
            <div class="lb-info">
                <div class="lb-name">${p.nickname}</div>
                <div class="lb-sub">${getArena().name}</div>
            </div>
            <div class="lb-value">${val}</div>
        </div>`;
    });

    // Me
    let myVal = type === 'level' ? '–£—Ä. ' + G.level : type === 'gold' ? formatNum(G.gold) + ' ü™ô' : G.refs + ' üë•';
    html += `<div class="lb-item me">
        <div class="lb-rank">...</div>
        <div class="lb-info">
            <div class="lb-name">${G.nick} (—Ç—ã)</div>
            <div class="lb-sub">${getArena().name}</div>
        </div>
        <div class="lb-value">${myVal}</div>
    </div>`;

    c.innerHTML = html;
}

// ============ GUIDE ============
function renderGuide() {
    // Arenas
    let html = '';
    let unlocked = 0;
    ARENAS.forEach(a => {
        const current = getArena().name === a.name;
        const locked = G.level < a.lvl;
        if (!locked) unlocked++;
        html += `<div class="guide-item ${current ? 'current' : ''} ${locked ? 'locked' : ''}">
            <div class="guide-icon">${a.name.split(' ')[0]}</div>
            <div class="guide-info">
                <div class="guide-name">${a.name}</div>
                <div class="guide-req">–£—Ä–æ–≤–µ–Ω—å ${a.lvl}+</div>
            </div>
            <div class="guide-status">${current ? 'üìç' : locked ? 'üîí' : '‚úÖ'}</div>
        </div>`;
    });
    document.getElementById('arenas-list').innerHTML = html;
    document.getElementById('arena-count').textContent = `(${unlocked}/10)`;

    // Heroes
    html = '';
    unlocked = 0;
    HEROES.forEach(h => {
        const current = getHero().name === h.name;
        const locked = G.level < h.lvl;
        if (!locked) unlocked++;
        html += `<div class="guide-item ${current ? 'current' : ''} ${locked ? 'locked' : ''}">
            <div class="guide-icon">${h.emoji}</div>
            <div class="guide-info">
                <div class="guide-name">${h.name}</div>
                <div class="guide-req">–£—Ä–æ–≤–µ–Ω—å ${h.lvl}+</div>
            </div>
            <div class="guide-status">${current ? 'üìç' : locked ? 'üîí' : '‚úÖ'}</div>
        </div>`;
    });
    document.getElementById('heroes-list').innerHTML = html;
    document.getElementById('hero-count').textContent = `(${unlocked}/10)`;
}

// ============ UI ============
function render() {
    document.getElementById('player-name').textContent = G.nick;
    document.getElementById('player-level').textContent = G.level;
    document.getElementById('gold-display').textContent = formatNum(G.gold);
    document.getElementById('gems-display').textContent = G.gems;
    document.getElementById('shop-gold').textContent = formatNum(G.gold);
    document.getElementById('shop-gems').textContent = G.gems;

    document.getElementById('gold-per-tap').textContent = '+' + getGoldPerTap();
    document.getElementById('gold-per-sec').textContent = '+' + getGoldPerSec();
    document.getElementById('total-taps').textContent = formatNum(G.taps);

    const need = getExpNeed();
    document.getElementById('current-exp').textContent = Math.floor(G.exp);
    document.getElementById('exp-needed').textContent = need;
    document.getElementById('exp-bar').style.width = (G.exp / need * 100) + '%';

    const arena = getArena();
    const next = getNextArena();
    document.getElementById('arena-name').textContent = arena.name;
    document.getElementById('arena-container').style.background = arena.bg;

    const hero = getHero();
    document.getElementById('character').textContent = hero.emoji;
    document.getElementById('arena-hero').textContent = hero.emoji;

    const pet = PETS.find(p => p.id === G.activePet) || PETS[0];
    document.getElementById('pet-display').textContent = pet.emoji;

    if (next) {
        document.getElementById('next-arena-level').textContent = next.lvl;
        const prog = (G.level - arena.lvl) / (next.lvl - arena.lvl) * 100;
        document.getElementById('arena-bar').style.width = prog + '%';
    } else {
        document.getElementById('next-arena-level').textContent = 'MAX';
        document.getElementById('arena-bar').style.width = '100%';
    }

    document.getElementById('daily-streak').textContent = G.streak;
    document.getElementById('ref-count').textContent = G.refs;
    document.getElementById('ref-bonus').textContent = '+' + (G.refs * 5);
}

function updateBoosts() {
    const c = document.getElementById('active-boosts');
    let html = '';
    if (G.boostDouble > Date.now()) {
        const sec = Math.ceil((G.boostDouble - Date.now()) / 1000);
        html += `<div class="boost-badge">üî• x2: ${formatTime(sec)}</div>`;
    }
    if (G.boostSuper > Date.now()) {
        const sec = Math.ceil((G.boostSuper - Date.now()) / 1000);
        html += `<div class="boost-badge">üí• x10: ${formatTime(sec)}</div>`;
    }
    c.innerHTML = html;
}

function showTapFeedback(e, amount) {
    const c = document.getElementById('arena-container');
    const rect = c.getBoundingClientRect();
    const fb = document.createElement('div');
    fb.className = 'tap-feedback';
    fb.textContent = '+' + amount;
    fb.style.left = (e.clientX - rect.left) + 'px';
    fb.style.top = (e.clientY - rect.top) + 'px';
    c.appendChild(fb);
    setTimeout(() => fb.remove(), 800);
}

function switchScreen(name) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
    document.querySelector(`[data-screen="${name}"]`).classList.add('active');

    if (name === 'top') loadLeaderboard('level');
    if (name === 'info') renderGuide();
    if (name === 'guild') renderGuild();
    if (name === 'shop') renderShop();
}

function toast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast ' + (type || '') + ' show';
    setTimeout(() => t.classList.remove('show'), 2500);
}

// ============ HELPERS ============
function getArena() {
    let a = ARENAS[0];
    for (const ar of ARENAS) if (G.level >= ar.lvl) a = ar;
    return a;
}

function getNextArena() {
    for (const ar of ARENAS) if (G.level < ar.lvl) return ar;
    return null;
}

function getHero() {
    let h = HEROES[0];
    for (const hr of HEROES) if (G.level >= hr.lvl) h = hr;
    return h;
}

function formatNum(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return Math.floor(n).toString();
}

function formatTime(sec) {
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return m + ':' + s.toString().padStart(2, '0');
}

// ============ REFERRAL ============
function updateRefLink() {
    const id = G.tgId || 'demo';
    document.getElementById('ref-link').textContent = 't.me/' + BOT_USERNAME + '?startapp=ref' + id;
}

function invite() {
    const id = G.tgId || 'demo';
    const link = 'https://t.me/' + BOT_USERNAME + '?startapp=ref' + id;
    const text = 'üéÆ –ò–≥—Ä–∞–π –≤ Tap Royale! –Ø –Ω–∞ —É—Ä–æ–≤–Ω–µ ' + G.level + '!';
    if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.openTelegramLink('https://t.me/share/url?url=' + encodeURIComponent(link) + '&text=' + encodeURIComponent(text));
    } else {
        copyLink();
    }
}

function copyLink() {
    const id = G.tgId || 'demo';
    navigator.clipboard.writeText('https://t.me/' + BOT_USERNAME + '?startapp=ref' + id);
    toast('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
}

// ============ SAVE/LOAD ============
function save() {
    try { localStorage.setItem('tapRoyaleV5', JSON.stringify(G)); } catch(e) {}
}

function load() {
    try {
        const s = localStorage.getItem('tapRoyaleV5');
        if (s) Object.assign(G, JSON.parse(s));
    } catch(e) {}
}

// ============ SERVER ============
async function syncServer() {
    if (!G.tgId) return;
    try {
        await fetch(API_URL + '/api/sync', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tg_id: G.tgId, nickname: G.nick, gold: G.gold, gems: G.gems, level: G.level, totalTaps: G.taps })
        });
    } catch(e) {}
}

// ============ START ============
init();
</script>
</body>
</html>