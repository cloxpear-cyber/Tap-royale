<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tap Royale</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 10px;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            margin-bottom: 10px;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .player-name {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .player-name .edit-icon {
            font-size: 12px;
            opacity: 0.7;
        }

        .player-level {
            font-size: 12px;
            color: #ffd700;
        }

        .currency-display {
            display: flex;
            gap: 15px;
        }

        .currency {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        .gold { color: #ffd700; }
        .gems { color: #e91e63; }

        /* Arena display */
        .arena-container {
            position: relative;
            height: 300px;
            border-radius: 20px;
            overflow: hidden;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: background 0.5s ease;
        }

        .arena-header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 8px 15px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .arena-name {
            font-size: 14px;
            font-weight: bold;
        }

        .arena-hero {
            font-size: 20px;
        }

        .character {
            font-size: 100px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.1s;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.3));
        }

        .character:active {
            transform: scale(0.9);
        }

        .character.tapped {
            animation: tap-effect 0.15s ease-out;
        }

        @keyframes tap-effect {
            0% { transform: scale(1); }
            50% { transform: scale(0.85); }
            100% { transform: scale(1); }
        }

        .tap-feedback {
            position: absolute;
            pointer-events: none;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255,215,0,0.8);
            animation: float-up 0.8s ease-out forwards;
        }

        @keyframes float-up {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.5); }
        }

        /* Progress bars */
        .progress-section {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .progress-item {
            margin-bottom: 10px;
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 5px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.exp { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .progress-fill.arena { background: linear-gradient(90deg, #2196f3, #03a9f4); }

        /* Stats */
        .stats-row {
            display: flex;
            justify-content: space-around;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.7;
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background: rgba(26, 26, 46, 0.95);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 5px 0;
            padding-bottom: max(5px, env(safe-area-inset-bottom));
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .nav-item.active {
            opacity: 1;
        }

        .nav-item span:first-child {
            font-size: 24px;
        }

        .nav-item span:last-child {
            font-size: 10px;
            margin-top: 2px;
        }

        /* Screens */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Shop Header with currency */
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .shop-title {
            font-size: 20px;
            font-weight: bold;
        }

        .shop-currency {
            display: flex;
            gap: 15px;
        }

        .shop-currency .currency {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 20px;
        }

        /* Shop */
        .shop-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .shop-tab {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        .shop-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .shop-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .shop-item {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .item-info p {
            font-size: 12px;
            opacity: 0.7;
        }

        .item-level {
            font-size: 11px;
            color: #4caf50;
            margin-top: 3px;
        }

        .buy-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s, opacity 0.2s;
        }

        .buy-btn:active {
            transform: scale(0.95);
        }

        .buy-btn.gold-btn {
            background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
            color: #1a1a2e;
        }

        .buy-btn.gem-btn {
            background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
            color: white;
        }

        .buy-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Leaderboard */
        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .leaderboard-tab {
            flex: 1;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }

        .leaderboard-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .leaderboard-item {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .leaderboard-item.me {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }

        .rank {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            font-size: 14px;
        }

        .rank.top1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; }
        .rank.top2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #1a1a2e; }
        .rank.top3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: white; }
        .rank.other { background: rgba(255,255,255,0.2); }

        .lb-player-info {
            flex: 1;
        }

        .lb-player-name {
            font-size: 14px;
            font-weight: bold;
        }

        .lb-player-arena {
            font-size: 11px;
            opacity: 0.7;
        }

        .lb-player-value {
            font-size: 14px;
            font-weight: bold;
            color: #ffd700;
        }

        /* Referral section */
        .referral-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .referral-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .referral-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
        }

        .ref-stat {
            text-align: center;
        }

        .ref-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }

        .ref-stat-label {
            font-size: 11px;
            opacity: 0.7;
        }

        .referral-bonus-info {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .referral-bonus-info p {
            margin-bottom: 5px;
        }

        .referral-bonus-info p:last-child {
            margin-bottom: 0;
        }

        .invite-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .invite-btn:active {
            transform: scale(0.98);
        }

        /* Accordion Guide */
        .guide-section {
            margin-bottom: 15px;
        }

        .accordion {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .accordion-header {
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: rgba(255,255,255,0.05);
        }

        .accordion-header:active {
            background: rgba(255,255,255,0.1);
        }

        .accordion-title {
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .accordion-arrow {
            font-size: 14px;
            transition: transform 0.3s;
        }

        .accordion.open .accordion-arrow {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .accordion.open .accordion-content {
            max-height: 2000px;
        }

        .accordion-inner {
            padding: 15px;
            padding-top: 5px;
        }

        .guide-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 8px;
        }

        .guide-item:last-child {
            margin-bottom: 0;
        }

        .guide-item.current {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border: 1px solid rgba(102, 126, 234, 0.5);
        }

        .guide-item.locked {
            opacity: 0.5;
        }

        .guide-icon {
            font-size: 30px;
            width: 40px;
            text-align: center;
        }

        .guide-info {
            flex: 1;
        }

        .guide-name {
            font-size: 14px;
            font-weight: bold;
        }

        .guide-level {
            font-size: 12px;
            opacity: 0.7;
        }

        .guide-status {
            font-size: 20px;
        }

        .tips-list {
            font-size: 13px;
            line-height: 1.6;
        }

        .tips-list p {
            margin-bottom: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .tips-list p:last-child {
            margin-bottom: 0;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            text-align: center;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        .toast.success {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 320px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
        }

        .modal-input:focus {
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Active boosts */
        .active-boosts {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .boost-badge {
            background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main Game Screen -->
        <div id="screen-game" class="screen active">
            <div class="header">
                <div class="player-info" onclick="openNicknameModal()">
                    <div class="player-name">
                        <span id="player-name">–ò–≥—Ä–æ–∫</span>
                        <span class="edit-icon">‚úèÔ∏è</span>
                    </div>
                    <div class="player-level">–£—Ä–æ–≤–µ–Ω—å <span id="player-level">1</span></div>
                </div>
                <div class="currency-display">
                    <div class="currency gold">
                        <span>ü™ô</span>
                        <span id="gold-display">0</span>
                    </div>
                    <div class="currency gems">
                        <span>üíé</span>
                        <span id="gems-display">0</span>
                    </div>
                </div>
            </div>

            <div id="active-boosts" class="active-boosts"></div>

            <div id="arena-container" class="arena-container">
                <div class="arena-header">
                    <span class="arena-hero" id="arena-hero">‚öîÔ∏è</span>
                    <span class="arena-name" id="arena-name">üè∞ –î–µ—Ä–µ–≤–Ω—è</span>
                </div>
                <div class="character" id="character" onclick="tap(event)">‚öîÔ∏è</div>
            </div>

            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-label">
                        <span>–û–ø—ã—Ç</span>
                        <span><span id="current-exp">0</span> / <span id="exp-needed">100</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill exp" id="exp-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="progress-item">
                    <div class="progress-label">
                        <span>–î–æ —Å–ª–µ–¥—É—é—â–µ–π –∞—Ä–µ–Ω—ã</span>
                        <span>–£—Ä–æ–≤–µ–Ω—å <span id="next-arena-level">5</span></span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill arena" id="arena-bar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="gold-per-tap">+1</div>
                    <div class="stat-label">–∑–∞ —Ç–∞–ø</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="gold-per-sec">+0</div>
                    <div class="stat-label">–≤ —Å–µ–∫—É–Ω–¥—É</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-taps">0</div>
                    <div class="stat-label">–≤—Å–µ–≥–æ —Ç–∞–ø–æ–≤</div>
                </div>
            </div>
        </div>

        <!-- Shop Screen -->
        <div id="screen-shop" class="screen">
            <div class="shop-header">
                <div class="shop-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
                <div class="shop-currency">
                    <div class="currency gold">
                        <span>ü™ô</span>
                        <span id="shop-gold-display">0</span>
                    </div>
                    <div class="currency gems">
                        <span>üíé</span>
                        <span id="shop-gems-display">0</span>
                    </div>
                </div>
            </div>

            <div class="shop-tabs">
                <button class="shop-tab active" onclick="switchShopTab('gold')">ü™ô –ó–∞ –∑–æ–ª–æ—Ç–æ</button>
                <button class="shop-tab" onclick="switchShopTab('gems')">üíé –ó–∞ –≥–µ–º—ã</button>
            </div>

            <div id="shop-gold" class="shop-items">
                <div class="shop-item">
                    <div class="item-info">
                        <h3>‚ö° –°–∏–ª–∞ —Ç–∞–ø–∞</h3>
                        <p>–ë–æ–ª—å—à–µ –∑–æ–ª–æ—Ç–∞ –∑–∞ –∫–ª–∏–∫</p>
                        <div class="item-level">–£—Ä–æ–≤–µ–Ω—å: <span id="upgrade-tap-level">0</span></div>
                    </div>
                    <button class="buy-btn gold-btn" onclick="buyUpgrade('tap')">
                        <span>ü™ô</span>
                        <span id="upgrade-tap-cost">100</span>
                    </button>
                </div>

                <div class="shop-item">
                    <div class="item-info">
                        <h3>ü§ñ –ê–≤—Ç–æ-–¥–æ—Ö–æ–¥</h3>
                        <p>–ó–æ–ª–æ—Ç–æ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É</p>
                        <div class="item-level">–£—Ä–æ–≤–µ–Ω—å: <span id="upgrade-auto-level">0</span></div>
                    </div>
                    <button class="buy-btn gold-btn" onclick="buyUpgrade('auto')">
                        <span>ü™ô</span>
                        <span id="upgrade-auto-cost">250</span>
                    </button>
                </div>

                <div class="shop-item">
                    <div class="item-info">
                        <h3>üìà –ú–Ω–æ–∂–∏—Ç–µ–ª—å –æ–ø—ã—Ç–∞</h3>
                        <p>–ë—ã—Å—Ç—Ä–µ–µ —Ä–∞—Å—Ç—ë—Ç —É—Ä–æ–≤–µ–Ω—å</p>
                        <div class="item-level">–£—Ä–æ–≤–µ–Ω—å: <span id="upgrade-exp-level">0</span></div>
                    </div>
                    <button class="buy-btn gold-btn" onclick="buyUpgrade('exp')">
                        <span>ü™ô</span>
                        <span id="upgrade-exp-cost">500</span>
                    </button>
                </div>
            </div>

            <div id="shop-gems" class="shop-items" style="display: none;">
                <div class="shop-item">
                    <div class="item-info">
                        <h3>üî• –î–≤–æ–π–Ω–æ–µ –∑–æ–ª–æ—Ç–æ</h3>
                        <p>x2 –∑–æ–ª–æ—Ç–æ –Ω–∞ 5 –º–∏–Ω—É—Ç</p>
                    </div>
                    <button class="buy-btn gem-btn" onclick="buyBoost('double', 5)">
                        <span>üíé</span>
                        <span>5</span>
                    </button>
                </div>

                <div class="shop-item">
                    <div class="item-info">
                        <h3>üí• –°—É–ø–µ—Ä —Ç–∞–ø</h3>
                        <p>x10 –∑–æ–ª–æ—Ç–æ –∑–∞ —Ç–∞–ø –Ω–∞ 1 –º–∏–Ω</p>
                    </div>
                    <button class="buy-btn gem-btn" onclick="buyBoost('super', 10)">
                        <span>üíé</span>
                        <span>10</span>
                    </button>
                </div>

                <div class="shop-item">
                    <div class="item-info">
                        <h3>‚≠ê –ú–µ–≥–∞ –æ–ø—ã—Ç</h3>
                        <p>+1000 –æ–ø—ã—Ç–∞ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ</p>
                    </div>
                    <button class="buy-btn gem-btn" onclick="buyBoost('megaexp', 8)">
                        <span>üíé</span>
                        <span>8</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div id="screen-top" class="screen">
            <h2 style="margin-bottom: 15px; text-align: center;">üèÜ –†–µ–π—Ç–∏–Ω–≥</h2>

            <div class="referral-section">
                <div class="referral-title">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div>
                <div class="referral-stats">
                    <div class="ref-stat">
                        <div class="ref-stat-value" id="ref-count">0</div>
                        <div class="ref-stat-label">–ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
                    </div>
                    <div class="ref-stat">
                        <div class="ref-stat-value" id="ref-bonus">0</div>
                        <div class="ref-stat-label">–±–æ–Ω—É—Å –∑–æ–ª–æ—Ç–∞/—Å–µ–∫</div>
                    </div>
                </div>
                <div class="referral-bonus-info">
                    <p>üéÅ <b>–ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞:</b> +500 –∑–æ–ª–æ—Ç–∞ –∏ +3 –≥–µ–º–∞</p>
                    <p>üí∞ <b>–ü–∞—Å—Å–∏–≤–Ω—ã–π –±–æ–Ω—É—Å:</b> +5 –∑–æ–ª–æ—Ç–∞/—Å–µ–∫ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –¥—Ä—É–≥–∞</p>
                    <p>‚≠ê <b>5 –¥—Ä—É–∑–µ–π:</b> –±–æ–Ω—É—Å x2 –∫ –ø–∞—Å—Å–∏–≤–Ω–æ–º—É –¥–æ—Ö–æ–¥—É</p>
                    <p>üöÄ <b>10 –¥—Ä—É–∑–µ–π:</b> –±–æ–Ω—É—Å x3 –∫ –ø–∞—Å—Å–∏–≤–Ω–æ–º—É –¥–æ—Ö–æ–¥—É</p>
                </div>
                <button class="invite-btn" onclick="inviteFriend()">
                    <span>üì®</span>
                    <span>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞</span>
                </button>
            </div>

            <div class="leaderboard-tabs">
                <button class="leaderboard-tab active" onclick="switchLeaderboardTab('level')">üéñÔ∏è –ü–æ —É—Ä–æ–≤–Ω—é</button>
                <button class="leaderboard-tab" onclick="switchLeaderboardTab('gold')">ü™ô –ü–æ –∑–æ–ª–æ—Ç—É</button>
                <button class="leaderboard-tab" onclick="switchLeaderboardTab('refs')">üë• –†–µ—Ñ–µ—Ä–∞–ª—ã</button>
            </div>

            <div id="leaderboard-list" class="leaderboard-list">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Guide Screen -->
        <div id="screen-guide" class="screen">
            <h2 style="margin-bottom: 15px; text-align: center;">üìñ –ü–∞–º—è—Ç–∫–∞</h2>

            <div class="guide-section">
                <!-- Arenas Accordion -->
                <div class="accordion" id="accordion-arenas">
                    <div class="accordion-header" onclick="toggleAccordion('arenas')">
                        <div class="accordion-title">
                            <span>üèüÔ∏è</span>
                            <span>–ê—Ä–µ–Ω—ã (<span id="arena-count">0</span>/10)</span>
                        </div>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-inner" id="arena-guide-list"></div>
                    </div>
                </div>

                <!-- Characters Accordion -->
                <div class="accordion" id="accordion-characters">
                    <div class="accordion-header" onclick="toggleAccordion('characters')">
                        <div class="accordion-title">
                            <span>ü¶∏</span>
                            <span>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (<span id="char-count">0</span>/10)</span>
                        </div>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-inner" id="character-guide-list"></div>
                    </div>
                </div>

                <!-- Tips Accordion -->
                <div class="accordion" id="accordion-tips">
                    <div class="accordion-header" onclick="toggleAccordion('tips')">
                        <div class="accordion-title">
                            <span>üí°</span>
                            <span>–°–æ–≤–µ—Ç—ã</span>
                        </div>
                        <span class="accordion-arrow">‚ñº</span>
                    </div>
                    <div class="accordion-content">
                        <div class="accordion-inner tips-list">
                            <p>‚ö° <b>–ü—Ä–æ–∫–∞—á–∏–≤–∞–π —Å–∏–ª—É —Ç–∞–ø–∞</b> ‚Äî —ç—Ç–æ –æ—Å–Ω–æ–≤–∞ —Ç–≤–æ–µ–≥–æ –¥–æ—Ö–æ–¥–∞</p>
                            <p>ü§ñ <b>–ê–≤—Ç–æ-–¥–æ—Ö–æ–¥</b> —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Ç—ã –Ω–µ –∏–≥—Ä–∞–µ—à—å</p>
                            <p>üíé <b>–ì–µ–º—ã</b> ‚Äî –∫–∞–∂–¥—ã–µ 50 —Ç–∞–ø–æ–≤ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å 1 –≥–µ–º</p>
                            <p>üë• <b>–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π</b> ‚Äî –ø–æ–ª—É—á–∞–π –±–æ–Ω—É—Å—ã –∏ –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥</p>
                            <p>üèÜ <b>–°–æ—Ä–µ–≤–Ω—É–π—Å—è</b> ‚Äî –ø–æ–ø–∞–¥–∏ –≤ —Ç–æ–ø —Ä–µ–π—Ç–∏–Ω–≥–∞!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchScreen('game')">
            <span>üéÆ</span>
            <span>–ò–≥—Ä–∞</span>
        </div>
        <div class="nav-item" onclick="switchScreen('shop')">
            <span>üõí</span>
            <span>–ú–∞–≥–∞–∑–∏–Ω</span>
        </div>
        <div class="nav-item" onclick="switchScreen('top')">
            <span>üèÜ</span>
            <span>–¢–æ–ø</span>
        </div>
        <div class="nav-item" onclick="switchScreen('guide')">
            <span>üìñ</span>
            <span>–ü–∞–º—è—Ç–∫–∞</span>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Nickname Modal -->
    <div id="nickname-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º</div>
            <input type="text" id="nickname-input" class="modal-input" placeholder="–í–≤–µ–¥–∏ –Ω–æ–≤—ã–π –Ω–∏–∫" maxlength="20">
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeNicknameModal()">–û—Ç–º–µ–Ω–∞</button>
                <button class="modal-btn confirm" onclick="saveNickname()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // ============ CONFIG ============
        const API_URL = 'https://taproyaleserver.onrender.com';
        const BOT_USERNAME = 'TapRoyaleGame_bot';

        // ============ GAME DATA - 10 ARENAS ============
        const ARENAS = [
            { id: 1, name: 'üè∞ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ª–∞–≥–µ—Ä—å', minLevel: 1, bg: 'linear-gradient(135deg, #2d5016 0%, #1a3a0a 100%)' },
            { id: 2, name: '‚öîÔ∏è –î–µ—Ä–µ–≤–Ω—è –≥–æ–±–ª–∏–Ω–æ–≤', minLevel: 5, bg: 'linear-gradient(135deg, #4a5d23 0%, #2e3d14 100%)' },
            { id: 3, name: 'üèØ –ö–æ—Å—Ç—è–Ω–æ–π –ª–µ—Å', minLevel: 12, bg: 'linear-gradient(135deg, #3d3d3d 0%, #1a1a1a 100%)' },
            { id: 4, name: 'üé™ –í–∞—Ä–≤–∞—Ä—Å–∫–∞—è –∞—Ä–µ–Ω–∞', minLevel: 20, bg: 'linear-gradient(135deg, #8b4513 0%, #5d2e0a 100%)' },
            { id: 5, name: '‚õèÔ∏è –®–∞—Ö—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â', minLevel: 30, bg: 'linear-gradient(135deg, #6b4423 0%, #3d2613 100%)' },
            { id: 6, name: 'üèõÔ∏è –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –¥–≤–æ—Ä', minLevel: 42, bg: 'linear-gradient(135deg, #4a148c 0%, #311b92 100%)' },
            { id: 7, name: 'üåã –û–≥–Ω–µ–Ω–Ω—ã–π –ø–∏–∫', minLevel: 55, bg: 'linear-gradient(135deg, #bf360c 0%, #8d1c06 100%)' },
            { id: 8, name: '‚ùÑÔ∏è –õ–µ–¥—è–Ω–∞—è –ø—É—Å—Ç–æ—à—å', minLevel: 70, bg: 'linear-gradient(135deg, #0277bd 0%, #01579b 100%)' },
            { id: 9, name: '‚ö° –ù–µ–±–µ—Å–Ω–∞—è –±–∞—à–Ω—è', minLevel: 88, bg: 'linear-gradient(135deg, #6a1b9a 0%, #4a148c 100%)' },
            { id: 10, name: 'üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è –∞—Ä–µ–Ω–∞', minLevel: 100, bg: 'linear-gradient(135deg, #ffd700 0%, #b8860b 100%)' }
        ];

        // ============ GAME DATA - 10 CHARACTERS ============
        const CHARACTERS = [
            { id: 1, name: '–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü', emoji: 'üó°Ô∏è', minLevel: 1 },
            { id: 2, name: '–õ—É—á–Ω–∏–∫', emoji: 'üèπ', minLevel: 5 },
            { id: 3, name: '–í–∞—Ä–≤–∞—Ä', emoji: '‚öîÔ∏è', minLevel: 12 },
            { id: 4, name: '–†—ã—Ü–∞—Ä—å', emoji: 'üõ°Ô∏è', minLevel: 20 },
            { id: 5, name: '–í–µ–ª–∏–∫–∞–Ω', emoji: 'üëä', minLevel: 30 },
            { id: 6, name: '–ú–∞–≥', emoji: 'üßô', minLevel: 42 },
            { id: 7, name: '–î—Ä–∞–∫–æ–Ω', emoji: 'üêâ', minLevel: 55 },
            { id: 8, name: '–õ–µ–¥—è–Ω–æ–π –º–∞–≥', emoji: 'üßä', minLevel: 70 },
            { id: 9, name: '–ü—Ä–∏–Ω—Ü', emoji: 'ü§¥', minLevel: 88 },
            { id: 10, name: '–ö–æ—Ä–æ–ª—å', emoji: 'üëë', minLevel: 100 }
        ];

        // ============ GAME STATE ============
        let gameState = {
            tg_id: null,
            tg_name: '–ò–≥—Ä–æ–∫',
            nickname: '',
            gold: 0,
            gems: 0,
            level: 1,
            exp: 0,
            totalTaps: 0,
            tapsForGem: 0,
            upgrades: {
                tap: { level: 0, cost: 100 },
                auto: { level: 0, cost: 250 },
                exp: { level: 0, cost: 500 }
            },
            boosts: {
                double: { active: false, endTime: 0 },
                super: { active: false, endTime: 0 }
            },
            referrals: 0,
            referralBonus: 0
        };

        // ============ TELEGRAM INIT ============
        let tg = window.Telegram?.WebApp;

        function initTelegram() {
            if (tg) {
                tg.ready();
                tg.expand();

                const user = tg.initDataUnsafe?.user;
                if (user) {
                    gameState.tg_id = user.id;
                    gameState.tg_name = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    if (!gameState.nickname) {
                        gameState.nickname = gameState.tg_name;
                    }
                }

                const startParam = tg.initDataUnsafe?.start_param;
                if (startParam && startParam.startsWith('ref_')) {
                    const refId = startParam.replace('ref_', '');
                    processReferral(refId);
                }
            }
        }

        // ============ API CALLS ============
        async function syncWithServer() {
            if (!API_URL || API_URL === 'YOUR_API_URL') return;

            try {
                const response = await fetch(`${API_URL}/api/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tg_id: gameState.tg_id,
                        tg_name: gameState.tg_name,
                        nickname: gameState.nickname,
                        gold: gameState.gold,
                        gems: gameState.gems,
                        level: gameState.level,
                        exp: gameState.exp,
                        totalTaps: gameState.totalTaps,
                        upgrades: gameState.upgrades,
                        referrals: gameState.referrals
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.referrals !== undefined) {
                        gameState.referrals = data.referrals;
                        gameState.referralBonus = calculateReferralBonus();
                    }
                }
            } catch (e) {
                console.log('Sync failed');
            }
        }

        async function loadLeaderboard(type) {
            if (!API_URL || API_URL === 'YOUR_API_URL') {
                return getDemoLeaderboard(type);
            }

            try {
                const response = await fetch(`${API_URL}/api/leaderboard?type=${type}`);
                if (response.ok) return await response.json();
            } catch (e) {}
            return getDemoLeaderboard(type);
        }

        async function processReferral(refId) {
            if (!API_URL || API_URL === 'YOUR_API_URL' || !gameState.tg_id || refId == gameState.tg_id) return;

            try {
                const response = await fetch(`${API_URL}/api/referral`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_user_id: gameState.tg_id, referrer_id: refId })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.bonus) {
                        gameState.gold += data.bonus.gold || 0;
                        gameState.gems += data.bonus.gems || 0;
                        showToast(`üéÅ –ë–æ–Ω—É—Å: +${data.bonus.gold} –∑–æ–ª–æ—Ç–∞, +${data.bonus.gems} –≥–µ–º–æ–≤!`, 'success');
                        saveGame();
                        updateDisplay();
                    }
                }
            } catch (e) {}
        }

        function getDemoLeaderboard(type) {
            return [
                { nickname: 'ProGamer', level: 95, gold: 1250000, arena: '‚ö° –ù–µ–±–µ—Å–Ω–∞—è –±–∞—à–Ω—è', referrals: 25 },
                { nickname: 'TapMaster', level: 78, gold: 890000, arena: '‚ùÑÔ∏è –õ–µ–¥—è–Ω–∞—è –ø—É—Å—Ç–æ—à—å', referrals: 18 },
                { nickname: 'CryptoKing', level: 62, gold: 670000, arena: 'üåã –û–≥–Ω–µ–Ω–Ω—ã–π –ø–∏–∫', referrals: 12 },
                { nickname: 'SpeedRunner', level: 48, gold: 420000, arena: 'üèõÔ∏è –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –¥–≤–æ—Ä', referrals: 8 },
                { nickname: 'NightOwl', level: 35, gold: 280000, arena: '‚õèÔ∏è –®–∞—Ö—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â', referrals: 5 }
            ];
        }

        // ============ GAME LOGIC ============
        function tap(event) {
            let goldEarned = getGoldPerTap();

            if (gameState.boosts.double.active && Date.now() < gameState.boosts.double.endTime) {
                goldEarned *= 2;
            }
            if (gameState.boosts.super.active && Date.now() < gameState.boosts.super.endTime) {
                goldEarned *= 10;
            }

            gameState.gold += goldEarned;
            gameState.totalTaps++;
            gameState.tapsForGem++;

            if (gameState.tapsForGem >= 50) {
                gameState.gems++;
                gameState.tapsForGem = 0;
                showToast('üíé +1 –≥–µ–º!', 'success');
            }

            const expEarned = getExpPerTap();
            gameState.exp += expEarned;
            checkLevelUp();

            showTapFeedback(event, goldEarned);
            animateCharacter();

            updateDisplay();
            saveGame();
        }

        function getGoldPerTap() {
            return 1 + gameState.upgrades.tap.level * 2;
        }

        function getGoldPerSec() {
            const base = gameState.upgrades.auto.level * 5;
            const refBonus = gameState.referralBonus;
            return base + refBonus;
        }

        function getExpPerTap() {
            return 1 + gameState.upgrades.exp.level;
        }

        function getExpNeeded() {
            return Math.floor(100 * Math.pow(1.5, gameState.level - 1));
        }

        function checkLevelUp() {
            let needed = getExpNeeded();
            while (gameState.exp >= needed) {
                gameState.exp -= needed;
                gameState.level++;
                showToast(`üéâ –£—Ä–æ–≤–µ–Ω—å ${gameState.level}!`, 'success');
                needed = getExpNeeded();
            }
        }

        function getCurrentArena() {
            let arena = ARENAS[0];
            for (const a of ARENAS) {
                if (gameState.level >= a.minLevel) arena = a;
            }
            return arena;
        }

        function getNextArena() {
            for (const a of ARENAS) {
                if (gameState.level < a.minLevel) return a;
            }
            return null;
        }

        function getCurrentCharacter() {
            let char = CHARACTERS[0];
            for (const c of CHARACTERS) {
                if (gameState.level >= c.minLevel) char = c;
            }
            return char;
        }

        function getUnlockedArenasCount() {
            return ARENAS.filter(a => gameState.level >= a.minLevel).length;
        }

        function getUnlockedCharsCount() {
            return CHARACTERS.filter(c => gameState.level >= c.minLevel).length;
        }

        function calculateReferralBonus() {
            let bonus = gameState.referrals * 5;
            if (gameState.referrals >= 10) bonus *= 3;
            else if (gameState.referrals >= 5) bonus *= 2;
            return bonus;
        }

        // ============ SHOP ============
        function buyUpgrade(type) {
            const upgrade = gameState.upgrades[type];
            if (gameState.gold < upgrade.cost) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!', 'error');
                return;
            }

            gameState.gold -= upgrade.cost;
            upgrade.level++;
            upgrade.cost = Math.floor(upgrade.cost * 1.8);

            showToast('‚úÖ –£–ª—É—á—à–µ–Ω–∏–µ –∫—É–ø–ª–µ–Ω–æ!', 'success');
            updateDisplay();
            saveGame();
            syncWithServer();
        }

        function buyBoost(type, cost) {
            if (gameState.gems < cost) {
                showToast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–º–æ–≤!', 'error');
                return;
            }

            gameState.gems -= cost;

            if (type === 'double') {
                gameState.boosts.double.active = true;
                gameState.boosts.double.endTime = Date.now() + 5 * 60 * 1000;
                showToast('üî• x2 –∑–æ–ª–æ—Ç–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ!', 'success');
            } else if (type === 'super') {
                gameState.boosts.super.active = true;
                gameState.boosts.super.endTime = Date.now() + 60 * 1000;
                showToast('üí• x10 —Ç–∞–ø –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
            } else if (type === 'megaexp') {
                gameState.exp += 1000;
                checkLevelUp();
                showToast('‚≠ê +1000 –æ–ø—ã—Ç–∞!', 'success');
            }

            updateDisplay();
            saveGame();
        }

        // ============ REFERRALS ============
        function inviteFriend() {
            const refLink = `https://t.me/${BOT_USERNAME}?startapp=ref_${gameState.tg_id || 'demo'}`;
            const text = `üéÆ –ò–≥—Ä–∞–π –≤ Tap Royale!
üëë –Ø –Ω–∞ —É—Ä–æ–≤–Ω–µ ${gameState.level}!
üéÅ –ë–æ–Ω—É—Å –ø–æ —Å—Å—ã–ª–∫–µ:`;

            if (tg) {
                tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(refLink)}&text=${encodeURIComponent(text)}`);
            } else {
                navigator.clipboard.writeText(refLink);
                showToast('üìã –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!', 'success');
            }
        }

        // ============ UI ============
        function updateDisplay() {
            // Currency (main + shop)
            document.getElementById('gold-display').textContent = formatNumber(gameState.gold);
            document.getElementById('gems-display').textContent = gameState.gems;
            document.getElementById('shop-gold-display').textContent = formatNumber(gameState.gold);
            document.getElementById('shop-gems-display').textContent = gameState.gems;

            // Player info
            document.getElementById('player-name').textContent = gameState.nickname || '–ò–≥—Ä–æ–∫';
            document.getElementById('player-level').textContent = gameState.level;

            // Stats
            document.getElementById('gold-per-tap').textContent = '+' + getGoldPerTap();
            document.getElementById('gold-per-sec').textContent = '+' + getGoldPerSec();
            document.getElementById('total-taps').textContent = formatNumber(gameState.totalTaps);

            // Experience
            const expNeeded = getExpNeeded();
            document.getElementById('current-exp').textContent = Math.floor(gameState.exp);
            document.getElementById('exp-needed').textContent = expNeeded;
            document.getElementById('exp-bar').style.width = (gameState.exp / expNeeded * 100) + '%';

            // Arena progress
            const nextArena = getNextArena();
            if (nextArena) {
                document.getElementById('next-arena-level').textContent = nextArena.minLevel;
                const currentArena = getCurrentArena();
                const prevLevel = currentArena.minLevel;
                const progress = (gameState.level - prevLevel) / (nextArena.minLevel - prevLevel) * 100;
                document.getElementById('arena-bar').style.width = progress + '%';
            } else {
                document.getElementById('next-arena-level').textContent = 'MAX';
                document.getElementById('arena-bar').style.width = '100%';
            }

            // Arena & Character
            const arena = getCurrentArena();
            const char = getCurrentCharacter();
            document.getElementById('arena-name').textContent = arena.name;
            document.getElementById('arena-hero').textContent = char.emoji;
            document.getElementById('arena-container').style.background = arena.bg;
            document.getElementById('character').textContent = char.emoji;

            // Shop
            document.getElementById('upgrade-tap-level').textContent = gameState.upgrades.tap.level;
            document.getElementById('upgrade-tap-cost').textContent = formatNumber(gameState.upgrades.tap.cost);
            document.getElementById('upgrade-auto-level').textContent = gameState.upgrades.auto.level;
            document.getElementById('upgrade-auto-cost').textContent = formatNumber(gameState.upgrades.auto.cost);
            document.getElementById('upgrade-exp-level').textContent = gameState.upgrades.exp.level;
            document.getElementById('upgrade-exp-cost').textContent = formatNumber(gameState.upgrades.exp.cost);

            // Referrals
            document.getElementById('ref-count').textContent = gameState.referrals;
            document.getElementById('ref-bonus').textContent = '+' + gameState.referralBonus;

            // Guide counts
            document.getElementById('arena-count').textContent = getUnlockedArenasCount();
            document.getElementById('char-count').textContent = getUnlockedCharsCount();

            updateBoostsDisplay();
        }

        function updateBoostsDisplay() {
            const container = document.getElementById('active-boosts');
            container.innerHTML = '';
            const now = Date.now();

            if (gameState.boosts.double.active && now < gameState.boosts.double.endTime) {
                const remaining = Math.ceil((gameState.boosts.double.endTime - now) / 1000);
                container.innerHTML += `<div class="boost-badge">üî• x2: ${formatTime(remaining)}</div>`;
            } else {
                gameState.boosts.double.active = false;
            }

            if (gameState.boosts.super.active && now < gameState.boosts.super.endTime) {
                const remaining = Math.ceil((gameState.boosts.super.endTime - now) / 1000);
                container.innerHTML += `<div class="boost-badge">üí• x10: ${formatTime(remaining)}</div>`;
            } else {
                gameState.boosts.super.active = false;
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        function showTapFeedback(event, amount) {
            const container = document.getElementById('arena-container');
            const rect = container.getBoundingClientRect();

            const feedback = document.createElement('div');
            feedback.className = 'tap-feedback';
            feedback.textContent = '+' + amount;
            feedback.style.left = (event.clientX - rect.left) + 'px';
            feedback.style.top = (event.clientY - rect.top) + 'px';

            container.appendChild(feedback);
            setTimeout(() => feedback.remove(), 800);
        }

        function animateCharacter() {
            const char = document.getElementById('character');
            char.classList.add('tapped');
            setTimeout(() => char.classList.remove('tapped'), 150);
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }

        // ============ SCREENS ============
        function switchScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById('screen-' + screen).classList.add('active');
            event.currentTarget.classList.add('active');

            if (screen === 'top') loadLeaderboardDisplay('level');
            if (screen === 'guide') renderGuide();
        }

        function switchShopTab(tab) {
            document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.getElementById('shop-gold').style.display = tab === 'gold' ? 'flex' : 'none';
            document.getElementById('shop-gems').style.display = tab === 'gems' ? 'flex' : 'none';
        }

        async function switchLeaderboardTab(tab) {
            document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            await loadLeaderboardDisplay(tab);
        }

        async function loadLeaderboardDisplay(type) {
            const container = document.getElementById('leaderboard-list');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const data = await loadLeaderboard(type);

            let html = '';
            data.forEach((player, index) => {
                const rank = index + 1;
                const rankClass = rank === 1 ? 'top1' : rank === 2 ? 'top2' : rank === 3 ? 'top3' : 'other';
                const isMe = player.tg_id === gameState.tg_id;

                let value = '';
                if (type === 'level') value = '–£—Ä. ' + player.level;
                else if (type === 'gold') value = 'ü™ô ' + formatNumber(player.gold);
                else if (type === 'refs') value = 'üë• ' + player.referrals;

                html += `
                    <div class="leaderboard-item ${isMe ? 'me' : ''}">
                        <div class="rank ${rankClass}">${rank}</div>
                        <div class="lb-player-info">
                            <div class="lb-player-name">${player.nickname}</div>
                            <div class="lb-player-arena">${player.arena || getArenaByLevel(player.level)}</div>
                        </div>
                        <div class="lb-player-value">${value}</div>
                    </div>
                `;
            });

            if (!data.find(p => p.tg_id === gameState.tg_id)) {
                const arena = getCurrentArena();
                let value = '';
                if (type === 'level') value = '–£—Ä. ' + gameState.level;
                else if (type === 'gold') value = 'ü™ô ' + formatNumber(gameState.gold);
                else if (type === 'refs') value = 'üë• ' + gameState.referrals;

                html += `
                    <div class="leaderboard-item me">
                        <div class="rank other">...</div>
                        <div class="lb-player-info">
                            <div class="lb-player-name">${gameState.nickname} (—Ç—ã)</div>
                            <div class="lb-player-arena">${arena.name}</div>
                        </div>
                        <div class="lb-player-value">${value}</div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function getArenaByLevel(level) {
            let arena = ARENAS[0];
            for (const a of ARENAS) {
                if (level >= a.minLevel) arena = a;
            }
            return arena.name;
        }

        // ============ ACCORDION ============
        function toggleAccordion(id) {
            const accordion = document.getElementById('accordion-' + id);
            accordion.classList.toggle('open');
        }

        function renderGuide() {
            // Arenas
            let arenaHtml = '';
            ARENAS.forEach(arena => {
                const isCurrent = getCurrentArena().id === arena.id;
                const isLocked = gameState.level < arena.minLevel;
                arenaHtml += `
                    <div class="guide-item ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''}">
                        <div class="guide-icon">${arena.name.split(' ')[0]}</div>
                        <div class="guide-info">
                            <div class="guide-name">${arena.name}</div>
                            <div class="guide-level">–£—Ä–æ–≤–µ–Ω—å ${arena.minLevel}+</div>
                        </div>
                        <div class="guide-status">${isCurrent ? 'üìç' : isLocked ? 'üîí' : '‚úÖ'}</div>
                    </div>
                `;
            });
            document.getElementById('arena-guide-list').innerHTML = arenaHtml;

            // Characters
            let charHtml = '';
            CHARACTERS.forEach(char => {
                const isCurrent = getCurrentCharacter().id === char.id;
                const isLocked = gameState.level < char.minLevel;
                charHtml += `
                    <div class="guide-item ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''}">
                        <div class="guide-icon">${char.emoji}</div>
                        <div class="guide-info">
                            <div class="guide-name">${char.name}</div>
                            <div class="guide-level">–£—Ä–æ–≤–µ–Ω—å ${char.minLevel}+</div>
                        </div>
                        <div class="guide-status">${isCurrent ? 'üìç' : isLocked ? 'üîí' : '‚úÖ'}</div>
                    </div>
                `;
            });
            document.getElementById('character-guide-list').innerHTML = charHtml;
        }

        // ============ NICKNAME ============
        function openNicknameModal() {
            document.getElementById('nickname-input').value = gameState.nickname;
            document.getElementById('nickname-modal').classList.add('show');
        }

        function closeNicknameModal() {
            document.getElementById('nickname-modal').classList.remove('show');
        }

        function saveNickname() {
            const newNick = document.getElementById('nickname-input').value.trim();
            if (newNick.length < 2) {
                showToast('‚ùå –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }
            if (newNick.length > 20) {
                showToast('‚ùå –ú–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }

            gameState.nickname = newNick;
            closeNicknameModal();
            showToast('‚úÖ –ù–∏–∫–Ω–µ–π–º –∏–∑–º–µ–Ω—ë–Ω!', 'success');
            updateDisplay();
            saveGame();
            syncWithServer();
        }

        // ============ SAVE/LOAD ============
        function saveGame() {
            localStorage.setItem('tapRoyale', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('tapRoyale');
            if (saved) {
                const data = JSON.parse(saved);
                gameState = { ...gameState, ...data };
            }
            gameState.referralBonus = calculateReferralBonus();
        }

        // ============ AUTO INCOME ============
        function autoIncome() {
            const income = getGoldPerSec();
            if (income > 0) {
                gameState.gold += income;
                updateDisplay();
                saveGame();
            }
        }

        // ============ INIT ============
        function init() {
            loadGame();
            initTelegram();
            updateDisplay();
            renderGuide();

            setInterval(autoIncome, 1000);
            setInterval(updateBoostsDisplay, 1000);
            setInterval(syncWithServer, 30000);
            setTimeout(syncWithServer, 2000);
        }

        init();
    </script>
</body>
</html>
