<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tap Royale</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); min-height: 100vh; color: white; overflow-x: hidden; }
        .container { max-width: 100%; padding: 10px; padding-bottom: 80px; }

        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 15px; margin-bottom: 10px; }
        .player-info { display: flex; flex-direction: column; cursor: pointer; }
        .player-name { font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .edit-icon { font-size: 12px; opacity: 0.6; }
        .player-level { font-size: 12px; color: #ffd700; }
        .currency-display { display: flex; gap: 15px; }
        .currency { display: flex; align-items: center; gap: 5px; font-size: 14px; font-weight: bold; }
        .gold { color: #ffd700; }
        .gems { color: #e91e63; }

        .daily-banner { background: linear-gradient(135deg, #ff9800, #f57c00); border-radius: 15px; padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .daily-banner.claimed { background: rgba(255,255,255,0.1); cursor: default; }
        .daily-info { display: flex; align-items: center; gap: 10px; }
        .daily-text { font-size: 14px; font-weight: bold; }
        .daily-sub { font-size: 11px; opacity: 0.9; }
        .daily-btn { background: rgba(255,255,255,0.3); border: none; padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold; }

        .pet-display { position: absolute; bottom: 15px; right: 15px; font-size: 40px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.3)); }
        .arena-container { position: relative; height: 260px; border-radius: 20px; overflow: hidden; margin-bottom: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .arena-header { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 10px; font-size: 14px; font-weight: bold; }
        .character { font-size: 90px; cursor: pointer; user-select: none; transition: transform 0.1s; }
        .character:active { transform: scale(0.85); }

        .tap-feedback { position: absolute; pointer-events: none; font-size: 24px; font-weight: bold; color: #ffd700; text-shadow: 0 0 10px rgba(255,215,0,0.8); animation: float-up 0.8s ease-out forwards; }
        @keyframes float-up { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-80px); } }

        .progress-section { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 12px; margin-bottom: 10px; }
        .progress-item { margin-bottom: 8px; }
        .progress-item:last-child { margin-bottom: 0; }
        .progress-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; }
        .progress-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; }
        .progress-fill.exp { background: linear-gradient(90deg, #4caf50, #8bc34a); }
        .progress-fill.arena { background: linear-gradient(90deg, #2196f3, #03a9f4); }

        .stats-row { display: flex; justify-content: space-around; background: rgba(255,255,255,0.1); border-radius: 15px; padding: 10px; margin-bottom: 10px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 16px; font-weight: bold; color: #ffd700; }
        .stat-label { font-size: 9px; opacity: 0.7; }

        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: rgba(26,26,46,0.98); border-top: 1px solid rgba(255,255,255,0.1); padding: 5px 0; padding-bottom: max(5px, env(safe-area-inset-bottom)); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer; opacity: 0.5; }
        .nav-item.active { opacity: 1; }
        .nav-item span:first-child { font-size: 18px; }
        .nav-item span:last-child { font-size: 9px; margin-top: 2px; }

        .screen { display: none; }
        .screen.active { display: block; }

        .section-title { font-size: 18px; font-weight: bold; text-align: center; margin-bottom: 15px; }
        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .shop-currency { display: flex; gap: 10px; }
        .shop-currency .currency { background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 15px; font-size: 12px; }

        .tabs { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .tab { flex: 1; min-width: 60px; padding: 8px 5px; background: rgba(255,255,255,0.1); border: none; border-radius: 10px; color: white; font-size: 11px; cursor: pointer; }
        .tab.active { background: linear-gradient(135deg, #667eea, #764ba2); }

        .items-list { display: flex; flex-direction: column; gap: 8px; }
        .item-card { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .item-card.selected { border: 2px solid #4caf50; background: rgba(76,175,80,0.2); }
        .item-info h3 { font-size: 13px; margin-bottom: 2px; }
        .item-info p { font-size: 10px; opacity: 0.7; }
        .item-level { font-size: 10px; color: #4caf50; margin-top: 2px; }

        .btn { padding: 8px 14px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .btn:active { transform: scale(0.95); }
        .btn-gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; }
        .btn-gem { background: linear-gradient(135deg, #e91e63, #9c27b0); color: white; }
        .btn-green { background: linear-gradient(135deg, #4caf50, #8bc34a); color: white; }
        .btn-blue { background: linear-gradient(135deg, #2196f3, #03a9f4); color: white; }
        .btn-red { background: linear-gradient(135deg, #f44336, #d32f2f); color: white; }
        .btn-gray { background: rgba(255,255,255,0.2); color: white; }
        .btn-full { width: 100%; justify-content: center; padding: 12px; font-size: 14px; }
        .btn-sm { padding: 6px 10px; font-size: 11px; }

        .referral-section { background: linear-gradient(135deg, rgba(102,126,234,0.2), rgba(118,75,162,0.2)); border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(102,126,234,0.3); }
        .referral-title { font-size: 15px; font-weight: bold; margin-bottom: 10px; }
        .referral-stats { display: flex; justify-content: space-around; margin-bottom: 12px; }
        .ref-stat { text-align: center; }
        .ref-stat-value { font-size: 22px; font-weight: bold; color: #ffd700; }
        .ref-stat-label { font-size: 10px; opacity: 0.7; }
        .referral-info { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-bottom: 12px; font-size: 11px; line-height: 1.5; }
        .ref-link-box { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 8px; margin-top: 10px; display: flex; align-items: center; gap: 8px; }
        .ref-link-text { flex: 1; font-size: 9px; word-break: break-all; opacity: 0.8; }

        .lb-list { display: flex; flex-direction: column; gap: 6px; }
        .lb-item { background: rgba(255,255,255,0.1); border-radius: 10px; padding: 10px; display: flex; align-items: center; gap: 10px; }
        .lb-item.me { background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3)); border: 1px solid rgba(102,126,234,0.5); }
        .lb-rank { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; font-size: 11px; background: rgba(255,255,255,0.2); }
        .lb-rank.top1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; }
        .lb-rank.top2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: #1a1a2e; }
        .lb-rank.top3 { background: linear-gradient(135deg, #cd7f32, #a0522d); color: white; }
        .lb-info { flex: 1; }
        .lb-name { font-size: 12px; font-weight: bold; }
        .lb-sub { font-size: 10px; opacity: 0.7; }
        .lb-value { font-size: 12px; font-weight: bold; color: #ffd700; }

        /* GUILD */
        .guild-card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 12px; }
        .guild-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .guild-name { font-size: 16px; font-weight: bold; }
        .guild-role { font-size: 11px; padding: 3px 8px; background: rgba(255,215,0,0.3); border-radius: 10px; color: #ffd700; }
        .guild-stats { display: flex; gap: 15px; margin-bottom: 12px; }
        .guild-stat { text-align: center; flex: 1; }
        .guild-stat-value { font-size: 18px; font-weight: bold; color: #ffd700; }
        .guild-stat-label { font-size: 9px; opacity: 0.7; }

        .treasury-section { background: linear-gradient(135deg, rgba(255,215,0,0.1), rgba(255,170,0,0.1)); border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(255,215,0,0.3); }
        .treasury-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .treasury-amount { font-size: 24px; font-weight: bold; color: #ffd700; text-align: center; margin-bottom: 10px; }
        .treasury-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .treasury-actions .btn { flex: 1; min-width: 80px; }

        .members-list { margin-top: 12px; }
        .members-title { font-size: 13px; font-weight: bold; margin-bottom: 8px; }
        .member-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 6px; }
        .member-info { flex: 1; }
        .member-name { font-size: 12px; font-weight: bold; }
        .member-donated { font-size: 10px; opacity: 0.7; }
        .member-level { font-size: 11px; color: #ffd700; }
        .member-actions { display: flex; gap: 5px; }

        .guild-list-item { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .guild-list-info h3 { font-size: 14px; margin-bottom: 2px; }
        .guild-list-info p { font-size: 10px; opacity: 0.7; }

        .create-form { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .form-input { width: 100%; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; font-size: 14px; margin-bottom: 10px; outline: none; }
        .form-input::placeholder { color: rgba(255,255,255,0.5); }

        /* ACCORDION */
        .accordion { background: rgba(255,255,255,0.1); border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
        .accordion-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .accordion-title { font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .accordion-arrow { transition: transform 0.3s; font-size: 12px; }
        .accordion.open .accordion-arrow { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s; }
        .accordion.open .accordion-content { max-height: 800px; }
        .accordion-inner { padding: 0 15px 15px; }

        .guide-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 6px; }
        .guide-item:last-child { margin-bottom: 0; }
        .guide-item.current { background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3)); }
        .guide-item.locked { opacity: 0.5; }
        .guide-icon { font-size: 24px; width: 30px; text-align: center; }
        .guide-info { flex: 1; }
        .guide-name { font-size: 12px; font-weight: bold; }
        .guide-req { font-size: 10px; opacity: 0.7; }
        .guide-status { font-size: 14px; }

        .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%) translateY(100px); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 20px; font-size: 13px; opacity: 0; transition: all 0.3s; z-index: 1000; }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { background: #4caf50; }
        .toast.error { background: #f44336; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-overlay.show { display: flex; }
        .modal { background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 20px; padding: 20px; width: 100%; max-width: 280px; }
        .modal-title { font-size: 16px; font-weight: bold; margin-bottom: 15px; text-align: center; }
        .modal-text { font-size: 13px; text-align: center; margin-bottom: 15px; opacity: 0.9; }
        .modal-icon { font-size: 40px; text-align: center; margin-bottom: 10px; }
        .modal-rewards { display: flex; justify-content: center; gap: 25px; margin-bottom: 15px; }
        .modal-reward { text-align: center; }
        .modal-reward-icon { font-size: 24px; }
        .modal-reward-amount { font-size: 14px; font-weight: bold; color: #ffd700; }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons .btn { flex: 1; justify-content: center; }

        .active-boosts { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .boost-badge { background: linear-gradient(135deg, #e91e63, #9c27b0); padding: 4px 8px; border-radius: 12px; font-size: 10px; }

        .loading { text-align: center; padding: 20px; opacity: 0.6; }
    </style>
</head>
<body>
    <div class="container">
        <!-- GAME -->
        <div id="screen-game" class="screen active">
            <div class="header">
                <div class="player-info" id="open-nick">
                    <div class="player-name"><span id="player-name">–ò–≥—Ä–æ–∫</span> <span class="edit-icon">‚úèÔ∏è</span></div>
                    <div class="player-level">–£—Ä–æ–≤–µ–Ω—å <span id="player-level">1</span></div>
                </div>
                <div class="currency-display">
                    <div class="currency gold">ü™ô <span id="gold-display">0</span></div>
                    <div class="currency gems">üíé <span id="gems-display">0</span></div>
                </div>
            </div>

            <div id="daily-banner" class="daily-banner">
                <div class="daily-info">
                    <span style="font-size:22px">üéÅ</span>
                    <div>
                        <div class="daily-text">–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞!</div>
                        <div class="daily-sub">–î–µ–Ω—å <span id="daily-streak">1</span></div>
                    </div>
                </div>
                <div class="daily-btn">–ó–∞–±—Ä–∞—Ç—å</div>
            </div>

            <div id="active-boosts" class="active-boosts"></div>

            <div id="arena-container" class="arena-container">
                <div class="arena-header">
                    <span id="arena-hero">üó°Ô∏è</span>
                    <span id="arena-name">üè∞ –õ–∞–≥–µ—Ä—å</span>
                </div>
                <div class="character" id="character">üó°Ô∏è</div>
                <div class="pet-display" id="pet-display">üê£</div>
            </div>

            <div class="progress-section">
                <div class="progress-item">
                    <div class="progress-label"><span>–û–ø—ã—Ç</span><span><span id="current-exp">0</span>/<span id="exp-needed">100</span></span></div>
                    <div class="progress-bar"><div class="progress-fill exp" id="exp-bar"></div></div>
                </div>
                <div class="progress-item">
                    <div class="progress-label"><span>–î–æ –∞—Ä–µ–Ω—ã</span><span>–£—Ä.<span id="next-arena-level">5</span></span></div>
                    <div class="progress-bar"><div class="progress-fill arena" id="arena-bar"></div></div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-item"><div class="stat-value" id="gold-per-tap">+1</div><div class="stat-label">–∑–∞ —Ç–∞–ø</div></div>
                <div class="stat-item"><div class="stat-value" id="gold-per-sec">+0</div><div class="stat-label">–≤ —Å–µ–∫</div></div>
                <div class="stat-item"><div class="stat-value" id="total-taps">0</div><div class="stat-label">—Ç–∞–ø–æ–≤</div></div>
            </div>
        </div>

        <!-- SHOP -->
        <div id="screen-shop" class="screen">
            <div class="shop-header">
                <div class="section-title">üõí –ú–∞–≥–∞–∑–∏–Ω</div>
                <div class="shop-currency">
                    <div class="currency gold">ü™ô <span id="shop-gold">0</span></div>
                    <div class="currency gems">üíé <span id="shop-gems">0</span></div>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" data-tab="upgrades">‚ö° –£–ª—É—á—à–µ–Ω–∏—è</button>
                <button class="tab" data-tab="boosts">üíé –ë—É—Å—Ç—ã</button>
                <button class="tab" data-tab="pets">üêæ –ü–∏—Ç–æ–º—Ü—ã</button>
            </div>
            <div id="tab-upgrades" class="items-list"></div>
            <div id="tab-boosts" class="items-list" style="display:none"></div>
            <div id="tab-pets" class="items-list" style="display:none"></div>
        </div>

        <!-- TOP -->
        <div id="screen-top" class="screen">
            <div class="section-title">üèÜ –†–µ–π—Ç–∏–Ω–≥</div>
            <div class="referral-section">
                <div class="referral-title">üë• –ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–∑–µ–π</div>
                <div class="referral-stats">
                    <div class="ref-stat"><div class="ref-stat-value" id="ref-count">0</div><div class="ref-stat-label">–¥—Ä—É–∑–µ–π</div></div>
                    <div class="ref-stat"><div class="ref-stat-value" id="ref-bonus">+0</div><div class="ref-stat-label">ü™ô/—Å–µ–∫</div></div>
                </div>
                <div class="referral-info">üéÅ –ó–∞ –¥—Ä—É–≥–∞: +500ü™ô +3üíé ‚Ä¢ –ü–∞—Å—Å–∏–≤: +5/—Å–µ–∫</div>
                <button class="btn btn-green btn-full" id="invite-btn">üì® –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
                <div class="ref-link-box">
                    <div class="ref-link-text" id="ref-link">–°—Å—ã–ª–∫–∞...</div>
                    <button class="btn btn-blue btn-sm" id="copy-btn">üìã</button>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" data-lb="level">üéñÔ∏è –£—Ä–æ–≤–µ–Ω—å</button>
                <button class="tab" data-lb="gold">ü™ô –ó–æ–ª–æ—Ç–æ</button>
                <button class="tab" data-lb="refs">üë• –î—Ä—É–∑—å—è</button>
            </div>
            <div id="leaderboard" class="lb-list"></div>
        </div>

        <!-- GUILD -->
        <div id="screen-guild" class="screen">
            <div class="section-title">üè∞ –ì–∏–ª—å–¥–∏—è</div>
            <div id="guild-content"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
            <div class="section-title" style="margin-top:20px">üèÜ –¢–æ–ø –≥–∏–ª—å–¥–∏–π</div>
            <div id="guild-top" class="lb-list"></div>
        </div>

        <!-- INFO -->
        <div id="screen-info" class="screen">
            <div class="section-title">üìñ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="accordion" id="acc-arenas">
                <div class="accordion-header">
                    <div class="accordion-title">üèüÔ∏è –ê—Ä–µ–Ω—ã <span id="arena-count">(0/10)</span></div>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content"><div class="accordion-inner" id="arenas-list"></div></div>
            </div>
            <div class="accordion" id="acc-heroes">
                <div class="accordion-header">
                    <div class="accordion-title">ü¶∏ –ì–µ—Ä–æ–∏ <span id="hero-count">(0/10)</span></div>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content"><div class="accordion-inner" id="heroes-list"></div></div>
            </div>
            <div class="accordion" id="acc-tips">
                <div class="accordion-header">
                    <div class="accordion-title">üí° –°–æ–≤–µ—Ç—ã</div>
                    <span class="accordion-arrow">‚ñº</span>
                </div>
                <div class="accordion-content">
                    <div class="accordion-inner">
                        <p style="font-size:12px;line-height:1.7">‚ö° –ö–∞—á–∞–π —Å–∏–ª—É —Ç–∞–ø–∞<br>ü§ñ –ê–≤—Ç–æ-–¥–æ—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞<br>üíé –ì–µ–º—ã: –∫–∞–∂–¥—ã–µ 50 —Ç–∞–ø–æ–≤<br>üéÅ –ó–∞—Ö–æ–¥–∏ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å<br>üêæ –ü–∏—Ç–æ–º—Ü—ã –¥–∞—é—Ç –±–æ–Ω—É—Å—ã<br>üè∞ –ì–∏–ª—å–¥–∏—è –¥–∞—ë—Ç +10% –∫ –¥–æ—Ö–æ–¥—É</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NAV -->
    <div class="nav-bar">
        <div class="nav-item active" data-screen="game"><span>üéÆ</span><span>–ò–≥—Ä–∞</span></div>
        <div class="nav-item" data-screen="shop"><span>üõí</span><span>–ú–∞–≥–∞–∑–∏–Ω</span></div>
        <div class="nav-item" data-screen="top"><span>üèÜ</span><span>–¢–æ–ø</span></div>
        <div class="nav-item" data-screen="guild"><span>üè∞</span><span>–ì–∏–ª—å–¥–∏—è</span></div>
        <div class="nav-item" data-screen="info"><span>üìñ</span><span>–ò–Ω—Ñ–æ</span></div>
    </div>

    <div id="toast" class="toast"></div>

    <!-- MODALS -->
    <div id="daily-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üéÅ –î–µ–Ω—å <span id="modal-day">1</span></div>
            <div class="modal-icon">üéâ</div>
            <div class="modal-rewards">
                <div class="modal-reward"><div class="modal-reward-icon">ü™ô</div><div class="modal-reward-amount" id="modal-gold">+100</div></div>
                <div class="modal-reward"><div class="modal-reward-icon">üíé</div><div class="modal-reward-amount" id="modal-gems">+1</div></div>
            </div>
            <button class="btn btn-green btn-full" id="claim-daily-btn">–ó–∞–±—Ä–∞—Ç—å!</button>
        </div>
    </div>

    <div id="nick-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫</div>
            <input type="text" class="form-input" id="nick-input" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫" maxlength="15">
            <div class="modal-buttons">
                <button class="btn btn-gray" id="nick-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-green" id="nick-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="create-guild-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üè∞ –°–æ–∑–¥–∞—Ç—å –≥–∏–ª—å–¥–∏—é</div>
            <div class="modal-text">–°—Ç–æ–∏–º–æ—Å—Ç—å: 5 üíé</div>
            <input type="text" class="form-input" id="guild-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" maxlength="15">
            <div class="modal-buttons">
                <button class="btn btn-gray" id="guild-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-gem" id="guild-create-btn">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="donate-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üí∞ –ü–æ–ø–æ–ª–Ω–∏—Ç—å –∫–∞–∑–Ω—É</div>
            <input type="number" class="form-input" id="donate-amount" placeholder="–°—É–º–º–∞" min="1">
            <div class="modal-buttons">
                <button class="btn btn-gray" id="donate-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-gold" id="donate-confirm">–í–Ω–µ—Å—Ç–∏</button>
            </div>
        </div>
    </div>

    <div id="give-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üéÅ –í—ã–¥–∞—Ç—å –∑–æ–ª–æ—Ç–æ</div>
            <div class="modal-text" id="give-to-name">–ò–≥—Ä–æ–∫—É: ...</div>
            <input type="number" class="form-input" id="give-amount" placeholder="–°—É–º–º–∞" min="1">
            <div class="modal-buttons">
                <button class="btn btn-gray" id="give-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-green" id="give-confirm">–í—ã–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="withdraw-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-title">üí∏ –ó–∞–±—Ä–∞—Ç—å –∏–∑ –∫–∞–∑–Ω—ã</div>
            <input type="number" class="form-input" id="withdraw-amount" placeholder="–°—É–º–º–∞" min="1">
            <div class="modal-buttons">
                <button class="btn btn-gray" id="withdraw-cancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-gold" id="withdraw-confirm">–ó–∞–±—Ä–∞—Ç—å</button>
            </div>
        </div>
    </div>

<script>
const API = 'https://taproyaleserver.onrender.com';
const BOT = 'TapRoyaleGame_bot';

const ARENAS = [
    {name:'üè∞ –¢—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—ã–π –ª–∞–≥–µ—Ä—å',lvl:1,bg:'linear-gradient(135deg,#2d5016,#1a3a0a)'},
    {name:'‚öîÔ∏è –î–µ—Ä–µ–≤–Ω—è –≥–æ–±–ª–∏–Ω–æ–≤',lvl:5,bg:'linear-gradient(135deg,#4a5d23,#2e3d14)'},
    {name:'üèØ –ö–æ—Å—Ç—è–Ω–æ–π –ª–µ—Å',lvl:12,bg:'linear-gradient(135deg,#3d3d3d,#1a1a1a)'},
    {name:'üé™ –í–∞—Ä–≤–∞—Ä—Å–∫–∞—è –∞—Ä–µ–Ω–∞',lvl:20,bg:'linear-gradient(135deg,#8b4513,#5d2e0a)'},
    {name:'‚õèÔ∏è –®–∞—Ö—Ç–∞ —Å–æ–∫—Ä–æ–≤–∏—â',lvl:30,bg:'linear-gradient(135deg,#6b4423,#3d2613)'},
    {name:'üèõÔ∏è –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –¥–≤–æ—Ä',lvl:42,bg:'linear-gradient(135deg,#4a148c,#311b92)'},
    {name:'üåã –û–≥–Ω–µ–Ω–Ω—ã–π –ø–∏–∫',lvl:55,bg:'linear-gradient(135deg,#bf360c,#8d1c06)'},
    {name:'‚ùÑÔ∏è –õ–µ–¥—è–Ω–∞—è –ø—É—Å—Ç–æ—à—å',lvl:70,bg:'linear-gradient(135deg,#0277bd,#01579b)'},
    {name:'‚ö° –ù–µ–±–µ—Å–Ω–∞—è –±–∞—à–Ω—è',lvl:88,bg:'linear-gradient(135deg,#6a1b9a,#4a148c)'},
    {name:'üëë –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è',lvl:100,bg:'linear-gradient(135deg,#ffd700,#b8860b)'}
];
const HEROES = [{name:'–ù–æ–≤–æ–±—Ä–∞–Ω–µ—Ü',e:'üó°Ô∏è',l:1},{name:'–õ—É—á–Ω–∏–∫',e:'üèπ',l:5},{name:'–í–∞—Ä–≤–∞—Ä',e:'‚öîÔ∏è',l:12},{name:'–†—ã—Ü–∞—Ä—å',e:'üõ°Ô∏è',l:20},{name:'–í–µ–ª–∏–∫–∞–Ω',e:'üëä',l:30},{name:'–ú–∞–≥',e:'üßô',l:42},{name:'–î—Ä–∞–∫–æ–Ω',e:'üêâ',l:55},{name:'–õ–µ–¥—è–Ω–æ–π –º–∞–≥',e:'üßä',l:70},{name:'–ü—Ä–∏–Ω—Ü',e:'ü§¥',l:88},{name:'–ö–æ—Ä–æ–ª—å',e:'üëë',l:100}];
const PETS = [{id:'chick',name:'–¶—ã–ø–ª—ë–Ω–æ–∫',e:'üê£',b:'+5% —Ç–∞–ø',c:0,m:{tap:1.05}},{id:'cat',name:'–ö–æ—Ç–∏–∫',e:'üê±',b:'+10% –∞–≤—Ç–æ',c:20,m:{auto:1.1}},{id:'dog',name:'–ü—ë—Å–∏–∫',e:'üê∂',b:'+1 –æ–ø—ã—Ç',c:25,m:{exp:1}},{id:'fox',name:'–õ–∏—Å–∏—á–∫–∞',e:'ü¶ä',b:'+5% –∫—Ä–∏—Ç',c:40,m:{crit:5}},{id:'dragon',name:'–î—Ä–∞–∫–æ–Ω—á–∏–∫',e:'üêâ',b:'+20% –≤—Å—ë',c:100,m:{all:1.2}},{id:'unicorn',name:'–ï–¥–∏–Ω–æ—Ä–æ–≥',e:'ü¶Ñ',b:'x2 –≥–µ–º—ã',c:150,m:{gems:2}}];
const UPGRADES = [{id:'tap',n:'‚ö° –°–∏–ª–∞ —Ç–∞–ø–∞',d:'+2 –∑–∞ –∫–ª–∏–∫',bc:100},{id:'auto',n:'ü§ñ –ê–≤—Ç–æ-–¥–æ—Ö–æ–¥',d:'+5/—Å–µ–∫',bc:250},{id:'exp',n:'üìà –û–ø—ã—Ç',d:'+1 –æ–ø—ã—Ç',bc:500},{id:'crit',n:'üéØ –ö—Ä–∏—Ç',d:'+5% —à–∞–Ω—Å x3',bc:1000}];
const BOOSTS = [{id:'double',n:'üî• x2 –∑–æ–ª–æ—Ç–æ',d:'5 –º–∏–Ω',c:5,dur:300000},{id:'super',n:'üí• x10 —Ç–∞–ø',d:'1 –º–∏–Ω',c:10,dur:60000},{id:'megaexp',n:'‚≠ê +1000 –æ–ø—ã—Ç–∞',d:'–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ',c:8},{id:'gold500',n:'üí∞ +500 –∑–æ–ª–æ—Ç–∞',d:'–ú–≥–Ω–æ–≤–µ–Ω–Ω–æ',c:3}];
const DAILY = [{g:100,d:1},{g:150,d:1},{g:200,d:2},{g:300,d:2},{g:400,d:3},{g:500,d:4},{g:750,d:5}];

let G = {tgId:null,nick:'–ò–≥—Ä–æ–∫',gold:0,gems:0,level:1,exp:0,taps:0,tapsForGem:0,ups:{tap:0,auto:0,exp:0,crit:0},costs:{tap:100,auto:250,exp:500,crit:1000},refs:0,streak:1,lastDaily:null,boostDouble:0,boostSuper:0,pets:['chick'],activePet:'chick'};
let myGuild = null;
let giveTargetId = null;

function init() {
    load();
    initTG();
    initEvents();
    checkDaily();
    render();
    renderShop();
    renderGuide();
    setInterval(autoIncome, 1000);
    setInterval(updateBoosts, 1000);
    setInterval(()=>syncServer(), 30000);
}

function initTG() {
    if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
        const u = Telegram.WebApp.initDataUnsafe?.user;
        if (u) { G.tgId = u.id; if (!localStorage.getItem('nickSet')) G.nick = u.first_name || '–ò–≥—Ä–æ–∫'; }
        const sp = Telegram.WebApp.initDataUnsafe?.start_param;
        if (sp && sp.startsWith('ref')) {
            const refId = sp.replace('ref','');
            if (refId && refId != G.tgId && !localStorage.getItem('refDone')) {
                G.gold += 500; G.gems += 3;
                localStorage.setItem('refDone','1');
                toast('üéÅ +500ü™ô +3üíé','success');
                save();
            }
        }
    }
    updateRefLink();
}

function initEvents() {
    document.getElementById('character').addEventListener('click', tap);
    document.querySelectorAll('.nav-item').forEach(el => el.addEventListener('click', () => switchScreen(el.dataset.screen)));
    document.querySelectorAll('.tab[data-tab]').forEach(el => el.addEventListener('click', () => switchShopTab(el.dataset.tab)));
    document.querySelectorAll('.tab[data-lb]').forEach(el => el.addEventListener('click', () => { document.querySelectorAll('.tab[data-lb]').forEach(t=>t.classList.remove('active')); el.classList.add('active'); loadLeaderboard(el.dataset.lb); }));
    document.querySelectorAll('.accordion-header').forEach(el => el.addEventListener('click', () => el.parentElement.classList.toggle('open')));
    document.getElementById('daily-banner').addEventListener('click', openDaily);
    document.getElementById('claim-daily-btn').addEventListener('click', claimDaily);
    document.getElementById('open-nick').addEventListener('click', () => { document.getElementById('nick-input').value = G.nick; document.getElementById('nick-modal').classList.add('show'); });
    document.getElementById('nick-cancel').addEventListener('click', () => document.getElementById('nick-modal').classList.remove('show'));
    document.getElementById('nick-save').addEventListener('click', saveNick);
    document.getElementById('invite-btn').addEventListener('click', invite);
    document.getElementById('copy-btn').addEventListener('click', copyLink);
    document.getElementById('guild-cancel').addEventListener('click', () => document.getElementById('create-guild-modal').classList.remove('show'));
    document.getElementById('guild-create-btn').addEventListener('click', createGuild);
    document.getElementById('donate-cancel').addEventListener('click', () => document.getElementById('donate-modal').classList.remove('show'));
    document.getElementById('donate-confirm').addEventListener('click', donateGold);
    document.getElementById('give-cancel').addEventListener('click', () => document.getElementById('give-modal').classList.remove('show'));
    document.getElementById('give-confirm').addEventListener('click', giveGold);
    document.getElementById('withdraw-cancel').addEventListener('click', () => document.getElementById('withdraw-modal').classList.remove('show'));
    document.getElementById('withdraw-confirm').addEventListener('click', withdrawGold);
}

// ===== GAME =====
function tap(e) {
    const pet = PETS.find(p => p.id === G.activePet) || PETS[0];
    let gold = 1 + G.ups.tap * 2;
    if (pet.m.tap) gold *= pet.m.tap;
    if (pet.m.all) gold *= pet.m.all;
    let critChance = G.ups.crit * 5; if (pet.m.crit) critChance += pet.m.crit;
    if (Math.random()*100 < critChance) gold *= 3;
    if (G.boostDouble > Date.now()) gold *= 2;
    if (G.boostSuper > Date.now()) gold *= 10;
    if (myGuild) gold *= 1.1;
    G.gold += Math.floor(gold);
    G.taps++; G.tapsForGem++;
    let gemsNeeded = pet.m.gems ? 25 : 50;
    if (G.tapsForGem >= gemsNeeded) { G.gems++; G.tapsForGem = 0; toast('üíé +1','success'); }
    let expGain = 1 + G.ups.exp; if (pet.m.exp) expGain += pet.m.exp; if (pet.m.all) expGain *= pet.m.all;
    G.exp += Math.floor(expGain);
    checkLevelUp();
    showTapFeedback(e, Math.floor(gold));
    render(); save();
}

function checkLevelUp() { let need = getExpNeed(); while (G.exp >= need) { G.exp -= need; G.level++; toast('üéâ –£—Ä–æ–≤–µ–Ω—å '+G.level+'!','success'); need = getExpNeed(); } }
function getExpNeed() { return Math.floor(100 * Math.pow(1.5, G.level - 1)); }
function getGoldPerTap() { let b = 1 + G.ups.tap * 2; const p = PETS.find(x => x.id === G.activePet); if (p?.m.tap) b *= p.m.tap; if (p?.m.all) b *= p.m.all; return Math.floor(b); }
function getGoldPerSec() { let b = G.ups.auto * 5 + G.refs * 5; const p = PETS.find(x => x.id === G.activePet); if (p?.m.auto) b *= p.m.auto; if (p?.m.all) b *= p.m.all; if (myGuild) b *= 1.1; return Math.floor(b); }
function autoIncome() { const inc = getGoldPerSec(); if (inc > 0) { let g = inc; if (G.boostDouble > Date.now()) g *= 2; G.gold += Math.floor(g); render(); save(); } }

// ===== SHOP =====
function renderShop() {
    let h = ''; UPGRADES.forEach(u => { h += `<div class="item-card"><div class="item-info"><h3>${u.n}</h3><p>${u.d}</p><div class="item-level">–£—Ä: ${G.ups[u.id]}</div></div><button class="btn btn-gold" data-buy="${u.id}">ü™ô ${formatNum(G.costs[u.id])}</button></div>`; });
    document.getElementById('tab-upgrades').innerHTML = h;
    h = ''; BOOSTS.forEach(b => { h += `<div class="item-card"><div class="item-info"><h3>${b.n}</h3><p>${b.d}</p></div><button class="btn btn-gem" data-boost="${b.id}">üíé ${b.c}</button></div>`; });
    document.getElementById('tab-boosts').innerHTML = h;
    h = ''; PETS.forEach(p => { const owned = G.pets.includes(p.id), active = G.activePet === p.id; h += `<div class="item-card ${active?'selected':''}"><div class="item-info"><h3>${p.e} ${p.name}</h3><p>${p.b}</p></div>${owned ? `<button class="btn ${active?'btn-green':'btn-blue'}" data-pet="${p.id}">${active?'‚úì':'–í—ã–±—Ä–∞—Ç—å'}</button>` : `<button class="btn btn-gem" data-buypet="${p.id}">üíé ${p.c}</button>`}</div>`; });
    document.getElementById('tab-pets').innerHTML = h;
    document.querySelectorAll('[data-buy]').forEach(el => el.addEventListener('click', () => buyUpgrade(el.dataset.buy)));
    document.querySelectorAll('[data-boost]').forEach(el => el.addEventListener('click', () => buyBoost(el.dataset.boost)));
    document.querySelectorAll('[data-pet]').forEach(el => el.addEventListener('click', () => selectPet(el.dataset.pet)));
    document.querySelectorAll('[data-buypet]').forEach(el => el.addEventListener('click', () => buyPet(el.dataset.buypet)));
}
function buyUpgrade(id) { if (G.gold < G.costs[id]) return toast('‚ùå –ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞','error'); G.gold -= G.costs[id]; G.ups[id]++; G.costs[id] = Math.floor(G.costs[id]*1.8); toast('‚úÖ –ö—É–ø–ª–µ–Ω–æ','success'); render(); renderShop(); save(); }
function buyBoost(id) { const b = BOOSTS.find(x=>x.id===id); if (G.gems < b.c) return toast('‚ùå –ú–∞–ª–æ –≥–µ–º–æ–≤','error'); G.gems -= b.c; if (id==='double') { G.boostDouble = Date.now()+b.dur; toast('üî• x2 –Ω–∞ 5–º–∏–Ω','success'); } else if (id==='super') { G.boostSuper = Date.now()+b.dur; toast('üí• x10 –Ω–∞ 1–º–∏–Ω','success'); } else if (id==='megaexp') { G.exp += 1000; checkLevelUp(); toast('‚≠ê +1000 –æ–ø—ã—Ç–∞','success'); } else if (id==='gold500') { G.gold += 500; toast('üí∞ +500','success'); } render(); save(); }
function buyPet(id) { const p = PETS.find(x=>x.id===id); if (G.gems < p.c) return toast('‚ùå –ú–∞–ª–æ –≥–µ–º–æ–≤','error'); G.gems -= p.c; G.pets.push(id); G.activePet = id; toast('üéâ '+p.e+' –∫—É–ø–ª–µ–Ω!','success'); render(); renderShop(); save(); }
function selectPet(id) { G.activePet = id; toast(PETS.find(p=>p.id===id).e+' –≤—ã–±—Ä–∞–Ω','success'); render(); renderShop(); save(); }
function switchShopTab(t) { document.querySelectorAll('.tab[data-tab]').forEach(x=>x.classList.remove('active')); document.querySelector(`[data-tab="${t}"]`).classList.add('active'); document.getElementById('tab-upgrades').style.display = t==='upgrades'?'flex':'none'; document.getElementById('tab-boosts').style.display = t==='boosts'?'flex':'none'; document.getElementById('tab-pets').style.display = t==='pets'?'flex':'none'; }

// ===== DAILY =====
function checkDaily() { const today = new Date().toDateString(), banner = document.getElementById('daily-banner'); if (G.lastDaily === today) { banner.classList.add('claimed'); banner.querySelector('.daily-text').textContent = '–ü–æ–ª—É—á–µ–Ω–æ!'; banner.querySelector('.daily-btn').textContent = '‚úì'; } else { banner.classList.remove('claimed'); banner.querySelector('.daily-text').textContent = '–ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞!'; banner.querySelector('.daily-btn').textContent = '–ó–∞–±—Ä–∞—Ç—å'; if (G.lastDaily) { const diff = Math.floor((new Date(today) - new Date(G.lastDaily))/86400000); if (diff===1) G.streak = Math.min(G.streak+1, 7); else if (diff>1) G.streak = 1; } } }
function openDaily() { if (G.lastDaily === new Date().toDateString()) return; const r = DAILY[G.streak-1]||DAILY[6]; document.getElementById('modal-day').textContent = G.streak; document.getElementById('modal-gold').textContent = '+'+r.g; document.getElementById('modal-gems').textContent = '+'+r.d; document.getElementById('daily-modal').classList.add('show'); }
function claimDaily() { const r = DAILY[G.streak-1]||DAILY[6]; G.gold += r.g; G.gems += r.d; G.lastDaily = new Date().toDateString(); document.getElementById('daily-modal').classList.remove('show'); toast('üéÅ +'+r.g+'ü™ô +'+r.d+'üíé','success'); checkDaily(); render(); save(); }

// ===== NICK =====
function saveNick() { const n = document.getElementById('nick-input').value.trim(); if (n.length<2) return toast('‚ùå –ú–∏–Ω 2 —Å–∏–º–≤–æ–ª–∞','error'); G.nick = n; localStorage.setItem('nickSet','1'); document.getElementById('nick-modal').classList.remove('show'); toast('‚úÖ –ù–∏–∫ –∏–∑–º–µ–Ω—ë–Ω','success'); render(); save(); syncServer(); }

// ===== GUILD =====
async function loadMyGuild() {
    if (!G.tgId) { myGuild = null; return; }
    try {
        const res = await fetch(API+'/api/guild/my?tg_id='+G.tgId);
        const data = await res.json();
        myGuild = data.guild;
    } catch(e) { myGuild = null; }
}

async function renderGuildScreen() {
    await loadMyGuild();
    const c = document.getElementById('guild-content');

    if (myGuild) {
        const isLeader = myGuild.leader_id == G.tgId;
        let membersHtml = '';
        (myGuild.members || []).forEach(m => {
            const isMe = m.tg_id == G.tgId;
            const isMemberLeader = m.role === 'leader';
            membersHtml += `<div class="member-item">
                <div class="member-info">
                    <div class="member-name">${isMemberLeader?'üëë ':''}${m.nickname}${isMe?' (—Ç—ã)':''}</div>
                    <div class="member-donated">–í–Ω—ë—Å: ${formatNum(m.donated||0)} ü™ô</div>
                </div>
                <div class="member-level">–£—Ä.${m.level}</div>
                ${isLeader && !isMe ? `<div class="member-actions">
                    <button class="btn btn-green btn-sm" data-give="${m.tg_id}" data-name="${m.nickname}">üí∞</button>
                    <button class="btn btn-red btn-sm" data-kick="${m.tg_id}">‚úï</button>
                </div>` : ''}
            </div>`;
        });

        c.innerHTML = `
            <div class="guild-card">
                <div class="guild-header">
                    <div class="guild-name">üè∞ ${myGuild.name}</div>
                    ${isLeader ? '<div class="guild-role">üëë –õ–∏–¥–µ—Ä</div>' : '<div class="guild-role">–£—á–∞—Å—Ç–Ω–∏–∫</div>'}
                </div>
                <div class="guild-stats">
                    <div class="guild-stat"><div class="guild-stat-value">${myGuild.member_count||1}</div><div class="guild-stat-label">—É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div></div>
                    <div class="guild-stat"><div class="guild-stat-value">${myGuild.total_level||G.level}</div><div class="guild-stat-label">–æ–±—â–∏–π —É—Ä.</div></div>
                    <div class="guild-stat"><div class="guild-stat-value">+10%</div><div class="guild-stat-label">–±–æ–Ω—É—Å</div></div>
                </div>
                <div class="treasury-section">
                    <div class="treasury-title">üí∞ –ö–∞–∑–Ω–∞ –≥–∏–ª—å–¥–∏–∏</div>
                    <div class="treasury-amount">${formatNum(myGuild.treasury||0)} ü™ô</div>
                    <div class="treasury-actions">
                        <button class="btn btn-gold" id="btn-donate">üì• –í–Ω–µ—Å—Ç–∏</button>
                        ${isLeader ? '<button class="btn btn-green" id="btn-withdraw">üì§ –ó–∞–±—Ä–∞—Ç—å</button>' : ''}
                    </div>
                </div>
                <div class="members-list">
                    <div class="members-title">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ (${myGuild.member_count||1}/20)</div>
                    ${membersHtml}
                </div>
                <button class="btn btn-red btn-full" id="btn-leave" style="margin-top:12px">üö™ –ü–æ–∫–∏–Ω—É—Ç—å</button>
            </div>`;

        document.getElementById('btn-donate').addEventListener('click', () => { document.getElementById('donate-amount').value = ''; document.getElementById('donate-modal').classList.add('show'); });
        if (isLeader) document.getElementById('btn-withdraw').addEventListener('click', () => { document.getElementById('withdraw-amount').value = ''; document.getElementById('withdraw-modal').classList.add('show'); });
        document.getElementById('btn-leave').addEventListener('click', leaveGuild);
        document.querySelectorAll('[data-give]').forEach(el => el.addEventListener('click', () => { giveTargetId = el.dataset.give; document.getElementById('give-to-name').textContent = '–ò–≥—Ä–æ–∫—É: '+el.dataset.name; document.getElementById('give-amount').value = ''; document.getElementById('give-modal').classList.add('show'); }));
        document.querySelectorAll('[data-kick]').forEach(el => el.addEventListener('click', () => kickMember(el.dataset.kick)));
    } else {
        c.innerHTML = `
            <div class="create-form">
                <p style="text-align:center;margin-bottom:10px;font-size:13px">–°–æ–∑–¥–∞–π –≥–∏–ª—å–¥–∏—é –∏–ª–∏ –≤—Å—Ç—É–ø–∏!</p>
                <p style="text-align:center;margin-bottom:15px;font-size:12px;opacity:0.8">üéÅ –ë–æ–Ω—É—Å: +10% –∫ –¥–æ—Ö–æ–¥—É</p>
                <button class="btn btn-gem btn-full" id="btn-open-create">üè∞ –°–æ–∑–¥–∞—Ç—å (5üíé)</button>
            </div>
            <div class="section-title" style="margin-top:15px">üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏</div>
            <div id="guilds-list" class="items-list"><div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>`;
        document.getElementById('btn-open-create').addEventListener('click', () => { document.getElementById('guild-name-input').value = ''; document.getElementById('create-guild-modal').classList.add('show'); });
        loadGuildsList();
    }

    loadGuildsTop();
}

async function loadGuildsList() {
    const c = document.getElementById('guilds-list');
    try {
        const res = await fetch(API+'/api/guilds');
        const guilds = await res.json();
        if (!guilds.length) { c.innerHTML = '<div class="loading">–ì–∏–ª—å–¥–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
        let h = '';
        guilds.slice(0,10).forEach(g => {
            h += `<div class="guild-list-item">
                <div class="guild-list-info"><h3>üè∞ ${g.name}</h3><p>${g.member_count}/20 ‚Ä¢ –£—Ä.${g.total_level}</p></div>
                <button class="btn btn-green btn-sm" data-join="${g.id}">–í—Å—Ç—É–ø–∏—Ç—å</button>
            </div>`;
        });
        c.innerHTML = h;
        document.querySelectorAll('[data-join]').forEach(el => el.addEventListener('click', () => joinGuild(el.dataset.join)));
    } catch(e) { c.innerHTML = '<div class="loading">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function loadGuildsTop() {
    const c = document.getElementById('guild-top');
    try {
        const res = await fetch(API+'/api/guilds');
        const guilds = await res.json();
        if (!guilds.length) { c.innerHTML = '<div class="loading">–ü–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
        let h = '';
        guilds.slice(0,10).forEach((g,i) => {
            const rc = i===0?'top1':i===1?'top2':i===2?'top3':'';
            h += `<div class="lb-item"><div class="lb-rank ${rc}">${i+1}</div><div class="lb-info"><div class="lb-name">üè∞ ${g.name}</div><div class="lb-sub">${g.member_count} —É—á.</div></div><div class="lb-value">–£—Ä.${g.total_level}</div></div>`;
        });
        c.innerHTML = h;
    } catch(e) { c.innerHTML = '<div class="loading">–û—à–∏–±–∫–∞</div>'; }
}

async function createGuild() {
    const name = document.getElementById('guild-name-input').value.trim();
    if (name.length < 2) return toast('‚ùå –ú–∏–Ω 2 —Å–∏–º–≤–æ–ª–∞','error');
    if (G.gems < 5) return toast('‚ùå –ù—É–∂–Ω–æ 5üíé','error');
    try {
        const res = await fetch(API+'/api/guild/create', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId, name}) });
        const data = await res.json();
        if (data.success) { G.gems -= 5; save(); document.getElementById('create-guild-modal').classList.remove('show'); toast('üè∞ –ì–∏–ª—å–¥–∏—è —Å–æ–∑–¥–∞–Ω–∞!','success'); renderGuildScreen(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏','error'); }
}

async function joinGuild(guildId) {
    try {
        const res = await fetch(API+'/api/guild/join', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId, guild_id:guildId}) });
        const data = await res.json();
        if (data.success) { toast('‚úÖ –í—ã –≤ –≥–∏–ª—å–¥–∏–∏!','success'); renderGuildScreen(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞','error'); }
}

async function leaveGuild() {
    try {
        const res = await fetch(API+'/api/guild/leave', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId}) });
        const data = await res.json();
        if (data.success) { myGuild = null; toast('üëã –í—ã –ø–æ–∫–∏–Ω—É–ª–∏ –≥–∏–ª—å–¥–∏—é','success'); renderGuildScreen(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞','error'); }
}

async function donateGold() {
    const amount = parseInt(document.getElementById('donate-amount').value) || 0;
    if (amount < 1) return toast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É','error');
    if (G.gold < amount) return toast('‚ùå –ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞','error');
    try {
        const res = await fetch(API+'/api/guild/donate', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId, amount}) });
        const data = await res.json();
        if (data.success) { G.gold -= amount; save(); document.getElementById('donate-modal').classList.remove('show'); toast('‚úÖ +'+amount+' –≤ –∫–∞–∑–Ω—É','success'); renderGuildScreen(); render(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞','error'); }
}

async function giveGold() {
    const amount = parseInt(document.getElementById('give-amount').value) || 0;
    if (amount < 1) return toast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É','error');
    try {
        const res = await fetch(API+'/api/guild/give', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId, target_id:giveTargetId, amount}) });
        const data = await res.json();
        if (data.success) { document.getElementById('give-modal').classList.remove('show'); toast('‚úÖ –í—ã–¥–∞–Ω–æ '+amount,'success'); renderGuildScreen(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞','error'); }
}

async function withdrawGold() {
    const amount = parseInt(document.getElementById('withdraw-amount').value) || 0;
    if (amount < 1) return toast('‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É','error');
    try {
        const res = await fetch(API+'/api/guild/withdraw', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId, amount}) });
        const data = await res.json();
        if (data.success) { G.gold += amount; save(); document.getElementById('withdraw-modal').classList.remove('show'); toast('‚úÖ +'+amount+' –∑–æ–ª–æ—Ç–∞','success'); renderGuildScreen(); render(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞','error'); }
}

async function kickMember(targetId) {
    try {
        const res = await fetch(API+'/api/guild/kick', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId, target_id:targetId}) });
        const data = await res.json();
        if (data.success) { toast('‚úÖ –ò–≥—Ä–æ–∫ –∏—Å–∫–ª—é—á—ë–Ω','success'); renderGuildScreen(); }
        else toast('‚ùå '+(data.error||'–û—à–∏–±–∫–∞'),'error');
    } catch(e) { toast('‚ùå –û—à–∏–±–∫–∞','error'); }
}

// ===== LEADERBOARD =====
async function loadLeaderboard(type) {
    const c = document.getElementById('leaderboard');
    c.innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    let data = [];
    try { const res = await fetch(API+'/api/leaderboard?type='+type); if (res.ok) data = await res.json(); } catch(e) {}
    if (!data.length) data = [{nickname:'ProGamer',level:95,gold:1250000,referrals:25},{nickname:'TapMaster',level:78,gold:890000,referrals:18}];
    let h = '';
    data.slice(0,10).forEach((p,i) => {
        const rc = i===0?'top1':i===1?'top2':i===2?'top3':'';
        let val = type==='level'?'–£—Ä.'+p.level:type==='gold'?formatNum(p.gold)+'ü™ô':(p.referrals||0)+'üë•';
        h += `<div class="lb-item"><div class="lb-rank ${rc}">${i+1}</div><div class="lb-info"><div class="lb-name">${p.nickname}</div><div class="lb-sub">${getArena().name}</div></div><div class="lb-value">${val}</div></div>`;
    });
    let myVal = type==='level'?'–£—Ä.'+G.level:type==='gold'?formatNum(G.gold)+'ü™ô':G.refs+'üë•';
    h += `<div class="lb-item me"><div class="lb-rank">...</div><div class="lb-info"><div class="lb-name">${G.nick} (—Ç—ã)</div><div class="lb-sub">${getArena().name}</div></div><div class="lb-value">${myVal}</div></div>`;
    c.innerHTML = h;
}

// ===== GUIDE =====
function renderGuide() {
    let h = '', u = 0;
    ARENAS.forEach(a => { const cur = getArena().name===a.name, lock = G.level<a.lvl; if(!lock) u++; h += `<div class="guide-item ${cur?'current':''} ${lock?'locked':''}"><div class="guide-icon">${a.name.split(' ')[0]}</div><div class="guide-info"><div class="guide-name">${a.name}</div><div class="guide-req">–£—Ä.${a.lvl}+</div></div><div class="guide-status">${cur?'üìç':lock?'üîí':'‚úÖ'}</div></div>`; });
    document.getElementById('arenas-list').innerHTML = h;
    document.getElementById('arena-count').textContent = `(${u}/10)`;
    h = ''; u = 0;
    HEROES.forEach(x => { const cur = getHero().name===x.name, lock = G.level<x.l; if(!lock) u++; h += `<div class="guide-item ${cur?'current':''} ${lock?'locked':''}"><div class="guide-icon">${x.e}</div><div class="guide-info"><div class="guide-name">${x.name}</div><div class="guide-req">–£—Ä.${x.l}+</div></div><div class="guide-status">${cur?'üìç':lock?'üîí':'‚úÖ'}</div></div>`; });
    document.getElementById('heroes-list').innerHTML = h;
    document.getElementById('hero-count').textContent = `(${u}/10)`;
}

// ===== UI =====
function render() {
    document.getElementById('player-name').textContent = G.nick;
    document.getElementById('player-level').textContent = G.level;
    document.getElementById('gold-display').textContent = formatNum(G.gold);
    document.getElementById('gems-display').textContent = G.gems;
    document.getElementById('shop-gold').textContent = formatNum(G.gold);
    document.getElementById('shop-gems').textContent = G.gems;
    document.getElementById('gold-per-tap').textContent = '+'+getGoldPerTap();
    document.getElementById('gold-per-sec').textContent = '+'+getGoldPerSec();
    document.getElementById('total-taps').textContent = formatNum(G.taps);
    const need = getExpNeed();
    document.getElementById('current-exp').textContent = Math.floor(G.exp);
    document.getElementById('exp-needed').textContent = need;
    document.getElementById('exp-bar').style.width = (G.exp/need*100)+'%';
    const arena = getArena(), next = getNextArena();
    document.getElementById('arena-name').textContent = arena.name;
    document.getElementById('arena-container').style.background = arena.bg;
    const hero = getHero();
    document.getElementById('character').textContent = hero.e;
    document.getElementById('arena-hero').textContent = hero.e;
    document.getElementById('pet-display').textContent = (PETS.find(p=>p.id===G.activePet)||PETS[0]).e;
    if (next) { document.getElementById('next-arena-level').textContent = next.lvl; document.getElementById('arena-bar').style.width = ((G.level-arena.lvl)/(next.lvl-arena.lvl)*100)+'%'; }
    else { document.getElementById('next-arena-level').textContent = 'MAX'; document.getElementById('arena-bar').style.width = '100%'; }
    document.getElementById('daily-streak').textContent = G.streak;
    document.getElementById('ref-count').textContent = G.refs;
    document.getElementById('ref-bonus').textContent = '+'+(G.refs*5);
}

function updateBoosts() { const c = document.getElementById('active-boosts'); let h = ''; if (G.boostDouble>Date.now()) h += `<div class="boost-badge">üî•x2 ${formatTime(Math.ceil((G.boostDouble-Date.now())/1000))}</div>`; if (G.boostSuper>Date.now()) h += `<div class="boost-badge">üí•x10 ${formatTime(Math.ceil((G.boostSuper-Date.now())/1000))}</div>`; c.innerHTML = h; }
function showTapFeedback(e,amt) { const c = document.getElementById('arena-container'), rect = c.getBoundingClientRect(), fb = document.createElement('div'); fb.className = 'tap-feedback'; fb.textContent = '+'+amt; fb.style.left = (e.clientX-rect.left)+'px'; fb.style.top = (e.clientY-rect.top)+'px'; c.appendChild(fb); setTimeout(()=>fb.remove(), 800); }
function switchScreen(name) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); document.getElementById('screen-'+name).classList.add('active'); document.querySelector(`[data-screen="${name}"]`).classList.add('active'); if (name==='top') loadLeaderboard('level'); if (name==='info') renderGuide(); if (name==='guild') renderGuildScreen(); if (name==='shop') renderShop(); }
function toast(msg,type) { const t = document.getElementById('toast'); t.textContent = msg; t.className = 'toast '+(type||'')+' show'; setTimeout(()=>t.classList.remove('show'), 2500); }

// ===== HELPERS =====
function getArena() { let a = ARENAS[0]; for (const x of ARENAS) if (G.level>=x.lvl) a = x; return a; }
function getNextArena() { for (const x of ARENAS) if (G.level<x.lvl) return x; return null; }
function getHero() { let h = HEROES[0]; for (const x of HEROES) if (G.level>=x.l) h = x; return h; }
function formatNum(n) { if (n>=1e6) return (n/1e6).toFixed(1)+'M'; if (n>=1e3) return (n/1e3).toFixed(1)+'K'; return Math.floor(n).toString(); }
function formatTime(s) { return Math.floor(s/60)+':'+(s%60).toString().padStart(2,'0'); }
function updateRefLink() { document.getElementById('ref-link').textContent = 't.me/'+BOT+'?startapp=ref'+(G.tgId||'demo'); }
function invite() { const link = 'https://t.me/'+BOT+'?startapp=ref'+(G.tgId||'demo'), text = 'üéÆ Tap Royale! –Ø –Ω–∞ —É—Ä.'+G.level; if (window.Telegram && Telegram.WebApp) Telegram.WebApp.openTelegramLink('https://t.me/share/url?url='+encodeURIComponent(link)+'&text='+encodeURIComponent(text)); else copyLink(); }
function copyLink() { navigator.clipboard.writeText('https://t.me/'+BOT+'?startapp=ref'+(G.tgId||'demo')); toast('üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','success'); }

// ===== SAVE/LOAD =====
function save() { try { localStorage.setItem('tapRoyaleV5', JSON.stringify(G)); } catch(e) {} }
function load() { try { const s = localStorage.getItem('tapRoyaleV5'); if (s) Object.assign(G, JSON.parse(s)); } catch(e) {} }
async function syncServer() { if (!G.tgId) return; try { await fetch(API+'/api/sync', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tg_id:G.tgId,nickname:G.nick,gold:G.gold,gems:G.gems,level:G.level,totalTaps:G.taps}) }); } catch(e) {} }

init();
</script>
</body>
</html>